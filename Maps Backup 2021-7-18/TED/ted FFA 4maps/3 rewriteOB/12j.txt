//===========================================================================
// 
// Mooncake_12FFA 180530
// 
//   Warcraft III map script
//   Generated by the Warcraft III World Editor
//   Date: Fri Jun  8 17:50:46 2018
//   Map Author: 213cy
// 
//===========================================================================

//***************************************************************************
//*
//*  Global Variables
//*
//***************************************************************************

globals
    // User-defined
    integer                 udg_temp_Int               = 0
    integer array           udg_PERM12
    string array            udg_PLAYER_NAME
    string array            udg_Name12_Str
    integer array           udg_Tab12_HeroIndex
    unit array              udg_Hero36_Uit
    player                  udg_temp_Ply               = null
    leaderboard             udg_Lb_score               = null
    race array              udg_PLAYER_RACE
    dialog                  udg_Dlg_race               = null
    boolean                 udg_temp_bool              = false
    integer array           udg_MAP_COLOR
    integer array           udg_MAP_NAME
    timer array             udg_LostBase12_Tim
    timerdialog array       udg_LostBase12_Win
    integer array           udg_Tab12_keyStructs
    player                  udg_current_Cripple_Ply    = null
    real                    udg_safeAreaX              = 0
    real                    udg_safeAreaY              = 0
    real                    udg_safeAreaR              = 0
    real                    udg_maxMapEdge             = 0
    integer                 udg_safeAreaM              = 0
    timer                   udg_Poison_Tim             = null
    unit array              udg_FogEdge64_Uit
    weathereffect array     udg_WeatherEffect
    unit array              udg_CreepsNew20_Uit
    location array          udg_CreepRegen4_Loc
    integer array           udg_CreepRegen10_Typ
    integer array           udg_CreepRegen20_Itm
    unit                    udg_temp_Uit               = null
    integer array           udg_MiniBase4_Itm
    integer array           udg_MAP_RACE
    integer array           udg_MAP_LOC
    effect array            udg_HeroVision3_Eft
    timer                   udg_GameEnd_Tim            = null
    multiboard              udg_MBoard                 = null

    // Generated
    trigger                 gg_trg_init_variable       = null
    trigger                 gg_trg_init_player         = null
    trigger                 gg_trg_init_game           = null
    trigger                 gg_trg_InitRaceSelectDialog_FUNC = null
    trigger                 gg_trg_CUSTOM_Melee_FUNC   = null
    trigger                 gg_trg_melee_init          = null
    trigger                 gg_trg_declare_variables   = null
    trigger                 gg_trg_debug_on            = null
    trigger                 gg_trg_debug               = null
    trigger                 gg_trg_debug_2             = null
    trigger                 gg_trg_test                = null
    trigger                 gg_trg_test_2              = null
    trigger                 gg_trg_init_Str_after_loading = null
    trigger                 gg_trg_init_Quest          = null
    trigger                 gg_trg_LB_hint             = null
    trigger                 gg_trg_LB_update           = null
    trigger                 gg_trg_LB_display          = null
    trigger                 gg_trg_LB_hide             = null
    trigger                 gg_trg_flash_FCN           = null
    trigger                 gg_trg_share_vision        = null
    trigger                 gg_trg_timer               = null
    trigger                 gg_trg_VictoryDefeat       = null
    trigger                 gg_trg_init_hero_minibase  = null
    trigger                 gg_trg_miniBase            = null
    trigger                 gg_trg_record_hero_train   = null
    trigger                 gg_trg_record_hero_sell    = null
    trigger                 gg_trg_DefeatPlayer_FUNC   = null
    trigger                 gg_trg_LostUnit            = null
    trigger                 gg_trg_BuildUnit           = null
    trigger                 gg_trg_gg_command          = null
    trigger                 gg_trg_PlayerLeft          = null
    trigger                 gg_trg_fog_FCN             = null
    trigger                 gg_trg_init_fog            = null
    trigger                 gg_trg_poison_FCN          = null
    trigger                 gg_trg_fog_dispersed       = null
    trigger                 gg_trg_fog_start           = null
    trigger                 gg_trg_fog_coming          = null
    trigger                 gg_trg_fog                 = null
    trigger                 gg_trg_init_creep          = null
    trigger                 gg_trg_check_regen         = null
    trigger                 gg_trg_hint_die            = null
    trigger                 gg_trg_creep_die           = null
    unit                    gg_unit_nogl_0054          = null
    unit                    gg_unit_nogl_0067          = null
    unit                    gg_unit_nogl_0072          = null
endglobals

function InitGlobals takes nothing returns nothing
    local integer i = 0
    set udg_temp_Int = 0
    set i = 0
    loop
        exitwhen (i > 12)
        set udg_PERM12[i] = 0
        set i = i + 1
    endloop

    set i = 0
    loop
        exitwhen (i > 12)
        set udg_PLAYER_NAME[i] = ""
        set i = i + 1
    endloop

    set i = 0
    loop
        exitwhen (i > 12)
        set udg_Name12_Str[i] = ""
        set i = i + 1
    endloop

    set i = 0
    loop
        exitwhen (i > 12)
        set udg_Tab12_HeroIndex[i] = 0
        set i = i + 1
    endloop

    set udg_Dlg_race = DialogCreate()
    set udg_temp_bool = false
    set i = 0
    loop
        exitwhen (i > 12)
        set udg_MAP_COLOR[i] = 0
        set i = i + 1
    endloop

    set i = 0
    loop
        exitwhen (i > 12)
        set udg_MAP_NAME[i] = 0
        set i = i + 1
    endloop

    set i = 0
    loop
        exitwhen (i > 12)
        set udg_LostBase12_Tim[i] = CreateTimer()
        set i = i + 1
    endloop

    set i = 0
    loop
        exitwhen (i > 12)
        set udg_Tab12_keyStructs[i] = 0
        set i = i + 1
    endloop

    set udg_safeAreaX = 0
    set udg_safeAreaY = 0
    set udg_safeAreaR = 0
    set udg_maxMapEdge = 0
    set udg_safeAreaM = 0
    set udg_Poison_Tim = CreateTimer()
    set i = 0
    loop
        exitwhen (i > 12)
        set udg_MAP_RACE[i] = 0
        set i = i + 1
    endloop

    set i = 0
    loop
        exitwhen (i > 12)
        set udg_MAP_LOC[i] = 0
        set i = i + 1
    endloop

    set udg_GameEnd_Tim = CreateTimer()
endfunction

//***************************************************************************
//*
//*  Custom Script Code
//*
//***************************************************************************
function Adjust_Player_Resource takes string Str returns nothing
    local integer IntA
    local integer IntB
    local player playerA
    local player playerB

    if (SubString( Str, 3, 4) == "-") then

        set IntA = S2I(SubString( Str, 2, 3))-1
        set IntB = S2I(SubString( Str, 4, 6))-1

    elseif (SubString( Str, 4, 5) == "-") then

        set IntA = S2I(SubString( Str, 2, 4))-1
        set IntB = S2I(SubString( Str, 5, 7))-1

    else
        call DisplayTextToForce( GetPlayersAll(), Str +" 错误输入!!找不到\"-\"" )
        return
    endif


    if (IntA < 0 or 11 < IntA) then
        call DisplayTextToForce( GetPlayersAll(), " 错误队伍1输入!!" + I2S(IntA) )
        return
    elseif (IntB < 0 or 11 < IntB) then
        call DisplayTextToForce( GetPlayersAll(), " 错误队伍2输入!!" + I2S(IntB) )
        return
    endif


    call AdjustPlayerStateBJ( GetPlayerState( Player(IntA), PLAYER_STATE_RESOURCE_GOLD), Player(IntB), PLAYER_STATE_RESOURCE_GOLD )
    call AdjustPlayerStateBJ( GetPlayerState( Player(IntA), PLAYER_STATE_RESOURCE_LUMBER), Player(IntB), PLAYER_STATE_RESOURCE_LUMBER )
    call SetPlayerState( Player(IntA), PLAYER_STATE_RESOURCE_GOLD, 0 )
    call SetPlayerState( Player(IntA), PLAYER_STATE_RESOURCE_LUMBER, 0 )

endfunction


//=========================================================

    // ----------------------------------------
    // ----------------------------------------



//===========================================================================







//***************************************************************************
//*
//*  Triggers
//*
//***************************************************************************

//===========================================================================
// Trigger: init variable
//===========================================================================
function Func_Random_Permute_PERM12 takes nothing returns nothing
    local integer    index
    local integer    temp

    set index = 1
    loop

        set temp = GetRandomInt(index, 12)
        set udg_PERM12[index - 1 ] = udg_PERM12[temp]
        set udg_PERM12[temp] = udg_PERM12[index]

        set index = index + 1
        exitwhen index == 12
    endloop

    set udg_PERM12[11] = udg_PERM12[12]
    set udg_PERM12[12] = udg_PERM12[0]
endfunction


function Trig_init_variable_Actions takes nothing returns nothing
    local integer    i
    local integer    k
    local player   indexPlayer



// -------dummy ID 初始化-------
    set udg_Name12_Str[1] = "Moon"
    set udg_Name12_Str[2] = "Grubby"
    set udg_Name12_Str[3] = "Sky"
    set udg_Name12_Str[4] = "Lyn"
    set udg_Name12_Str[5] = "TH000"
    set udg_Name12_Str[6] = "Infi"
    set udg_Name12_Str[7] = "Fly100%"
    set udg_Name12_Str[8] = "TED"
    set udg_Name12_Str[9] = "Life"
    set udg_Name12_Str[10] = "斗败公鸡"
    set udg_Name12_Str[11] = "两厘米"
    set udg_Name12_Str[12] = "特短"

// -------随机排列初始化-------
    set i = 0
    loop

        set udg_PERM12[i] = i

        set i = i + 1
        exitwhen (i > 12)
    endloop

//
    call Func_Random_Permute_PERM12()
    set i = 1
    loop

        set udg_MAP_COLOR[i] = udg_PERM12[i]

        set i = i + 1
        exitwhen (i > 12)
    endloop

//
    call Func_Random_Permute_PERM12()
    set i = 1
    loop

        set udg_MAP_NAME[i] = udg_PERM12[i]

        set i = i + 1
        exitwhen (i > 12)
    endloop

//
    call Func_Random_Permute_PERM12()
    set i = 1
    set k = 1
    loop
        set indexPlayer = Player(udg_PERM12[i] - 1)

        if (GetPlayerSlotState(indexPlayer) == PLAYER_SLOT_STATE_PLAYING) then
            set udg_MAP_LOC[udg_PERM12[i]] = k
            set k = k + 1
        endif

        set i = i + 1
        exitwhen (i > 12)
    endloop

//
    set i = 1
    loop
        set indexPlayer = Player(i-1)
        //if (GetPlayerController(indexPlayer) == MAP_CONTROL_COMPUTER) then

            if ( GetPlayerRace(indexPlayer) == RACE_HUMAN ) then
                set udg_MAP_RACE[i] = 1
            elseif ( GetPlayerRace(indexPlayer) == RACE_ORC ) then
                set udg_MAP_RACE[i] = 2
            elseif ( GetPlayerRace(indexPlayer) == RACE_UNDEAD ) then
                set udg_MAP_RACE[i] = 3
            elseif ( GetPlayerRace(indexPlayer) == RACE_NIGHTELF ) then
                set udg_MAP_RACE[i] = 4
            endif

        //endif

        set i = i + 1
        exitwhen (i > 12)
    endloop

endfunction

//===========================================================================
function InitTrig_init_variable takes nothing returns nothing
    set gg_trg_init_variable = CreateTrigger(  )
    call TriggerAddAction( gg_trg_init_variable, function Trig_init_variable_Actions )
endfunction

//===========================================================================
// Trigger: init player
//===========================================================================
function Trig_init_player_Func004A takes nothing returns nothing
    set udg_temp_Int = GetConvertedPlayerId(GetEnumPlayer())
    // -------- -------- -------- -------- --------
    set udg_PLAYER_NAME[udg_temp_Int] = GetPlayerName(GetEnumPlayer())
    // -------- -------- -------- -------- --------
    set udg_Tab12_keyStructs[udg_temp_Int] = 11
    set udg_LostBase12_Win[udg_temp_Int] = CreateTimerDialog(udg_LostBase12_Tim[udg_temp_Int])
    // -------- -------- -------- -------- --------
    call SetPlayerAlliance( Player(bj_PLAYER_NEUTRAL_EXTRA), GetEnumPlayer(), ALLIANCE_SHARED_VISION, true)
    // -------- -------- -------- -------- --------
    call TriggerRegisterPlayerEventLeave( gg_trg_PlayerLeft, GetEnumPlayer() )
    call TriggerRegisterPlayerChatEvent( gg_trg_gg_command, GetEnumPlayer(), "gg", true )
endfunction

function Trig_init_player_Actions takes nothing returns nothing
    set bj_forLoopAIndex = 0
    set bj_forLoopAIndexEnd = 11
    loop
        exitwhen bj_forLoopAIndex > bj_forLoopAIndexEnd
        call SetPlayerTeam( Player(bj_forLoopAIndex), bj_forLoopAIndex )
        // ------随机颜色--------
        call SetPlayerColor( Player(bj_forLoopAIndex), ConvertPlayerColor(udg_MAP_COLOR[bj_forLoopAIndex + 1] - 1) )
        call SetPlayerStartLocation( Player(bj_forLoopAIndex), udg_MAP_LOC[bj_forLoopAIndex+1] - 1 )
        call SetPlayerState(Player(bj_forLoopAIndex), PLAYER_STATE_RESOURCE_HERO_TOKENS, bj_MELEE_STARTING_HERO_TOKENS)
        set bj_forLoopBIndex = 0
        set bj_forLoopBIndexEnd = 11
        loop
            exitwhen bj_forLoopBIndex > bj_forLoopBIndexEnd
            call SetPlayerAllianceStateBJ( Player(bj_forLoopAIndex), Player(bj_forLoopBIndex), bj_ALLIANCE_UNALLIED )
            set bj_forLoopBIndex = bj_forLoopBIndex + 1
        endloop
        set bj_forLoopAIndex = bj_forLoopAIndex + 1
    endloop
    // ====================
    call ForForce( GetPlayersAll(), function Trig_init_player_Func004A )
    // ====================
endfunction

//===========================================================================
function InitTrig_init_player takes nothing returns nothing
    set gg_trg_init_player = CreateTrigger(  )
    call TriggerAddAction( gg_trg_init_player, function Trig_init_player_Actions )
endfunction

//===========================================================================
// Trigger: init game
//===========================================================================
function Trig_init_game_Actions takes nothing returns nothing
    call Preloader( "scripts\\SharedMelee.pld" )
    call Preloader( "scripts\\HumanMelee.pld" )
    call Preloader( "scripts\\OrcMelee.pld" )
    call Preloader( "scripts\\UndeadMelee.pld" )
    call Preloader( "scripts\\NightElfMelee.pld" )
    // ====================
    call MeleeStartingVisibility(  )
    call MeleeStartingHeroLimit(  )
    call MeleeGrantHeroItems(  )
    call MeleeStartingResources(  )
    call MeleeClearExcessUnits(  )
    // ====================
endfunction

//===========================================================================
function InitTrig_init_game takes nothing returns nothing
    set gg_trg_init_game = CreateTrigger(  )
    call TriggerAddAction( gg_trg_init_game, function Trig_init_game_Actions )
endfunction

//===========================================================================
// Trigger: InitRaceSelectDialog FUNC
//===========================================================================
function Func_SetRandomRace takes nothing returns nothing
    //call DisplayTextToForce( GetPlayersAll(), GetPlayerName(GetTriggerPlayer()) )
    //set udg_PLAYER_RACE[ GetPlayerId(GetTriggerPlayer()) + 1 ] = ConvertRace( GetRandomInt( 1, 4) )
    set udg_MAP_RACE[ GetPlayerId(GetTriggerPlayer()) + 1 ] = GetRandomInt( 1, 4) 
    if (GetLocalPlayer() == GetTriggerPlayer()) then
        call DisplayTextToPlayer( GetLocalPlayer(), 0, 0, "you selected random race!" )
    endif
endfunction

function Func_SetHumanRace takes nothing returns nothing
    //set udg_PLAYER_RACE[ GetPlayerId(GetTriggerPlayer()) + 1 ] = RACE_HUMAN
    set udg_MAP_RACE[ GetPlayerId(GetTriggerPlayer()) + 1 ] = 1
    if (GetLocalPlayer() == GetTriggerPlayer()) then
        call DisplayTextToPlayer( GetLocalPlayer(), 0, 0, "you selected Human!" )
    endif
endfunction

function Func_SetOrcRace takes nothing returns nothing
    //set udg_PLAYER_RACE[ GetPlayerId(GetTriggerPlayer()) + 1 ] = RACE_ORC
    set udg_MAP_RACE[ GetPlayerId(GetTriggerPlayer()) + 1 ] = 2
    if (GetLocalPlayer() == GetTriggerPlayer()) then
        call DisplayTextToPlayer( GetLocalPlayer(), 0, 0, "you selected Orc!" )
    endif
endfunction

function Func_SetUndeadRace takes nothing returns nothing
    //set udg_PLAYER_RACE[ GetPlayerId(GetTriggerPlayer()) + 1 ] = RACE_UNDEAD
    set udg_MAP_RACE[ GetPlayerId(GetTriggerPlayer()) + 1 ] = 3
    if (GetLocalPlayer() == GetTriggerPlayer()) then
        call DisplayTextToPlayer( GetLocalPlayer(), 0, 0, "you selected Undead!" )
    endif
endfunction

function Func_SetNightElfRace takes nothing returns nothing
    //set udg_PLAYER_RACE[ GetPlayerId(GetTriggerPlayer()) + 1 ] = RACE_NIGHTELF
    set udg_MAP_RACE[ GetPlayerId(GetTriggerPlayer()) + 1 ] = 4
    if (GetLocalPlayer() == GetTriggerPlayer()) then
        call DisplayTextToPlayer( GetLocalPlayer(), 0, 0, "you selected NightElf!" )
    endif
endfunction

function InitRaceSelectDialog takes nothing returns nothing
    local trigger t

        //call DialogSetMessage( udg_Dlg_race, "Room choice obsoleted|nSelect your race again(4):"  )
        //call DialogSetMessage( udg_Dlg_race, "Select your race :"  )

        set t = CreateTrigger()
        //call DialogAddButton( udg_Dlg_race, "RANDOM(R)", 0  )
        call TriggerRegisterDialogButtonEvent( t, DialogAddButton( udg_Dlg_race, "RANDOM(|CffffffffR|R)", 82  ) )
        call TriggerAddAction( t, function Func_SetRandomRace )

        set t = CreateTrigger()
        call TriggerRegisterDialogButtonEvent( t, DialogAddButton( udg_Dlg_race, "HUMAN(|CffffffffH|R)", 72 ) )
        call TriggerAddAction( t, function Func_SetHumanRace )

        set t = CreateTrigger()
        call TriggerRegisterDialogButtonEvent( t, DialogAddButton( udg_Dlg_race, "ORC(|CffffffffO|R)", 79 ) )
        call TriggerAddAction( t, function Func_SetOrcRace )

        set t = CreateTrigger()
        call TriggerRegisterDialogButtonEvent( t, DialogAddButton( udg_Dlg_race, "UNDEAD(|CffffffffU|R)", 85 ) )
        call TriggerAddAction( t, function Func_SetUndeadRace )
        
        set t = CreateTrigger()
        call TriggerRegisterDialogButtonEvent( t, DialogAddButton( udg_Dlg_race, "NIGHTELF(|CffffffffN|R)", 78 ) )
        call TriggerAddAction( t, function Func_SetNightElfRace )

endfunction

//===========================================================================
function InitTrig_InitRaceSelectDialog_FUNC takes nothing returns nothing
endfunction

//===========================================================================
// Trigger: CUSTOM Melee FUNC
//===========================================================================
//===========================================================================

function Custom_MeleeStartingUnits takes nothing returns nothing
    local integer  index
    local player   indexPlayer
    local location indexStartLoc
    local integer    indexRace
    //local race     indexRace


    set index = 1
    loop
        set indexPlayer = Player(index - 1)
        if (GetPlayerSlotState(indexPlayer) == PLAYER_SLOT_STATE_PLAYING) then
            set indexStartLoc = GetStartLocationLoc(GetPlayerStartLocation(indexPlayer))
            //set indexStartLoc = GetStartLocationLoc( udg_MAP_LOC[index] - 1 )
            //set indexRace = udg_PLAYER_RACE[index]
            set indexRace = udg_MAP_RACE[index]

            // Create initial race-specific starting units
            if (indexRace == 1) then
                call MeleeStartingUnitsHuman(indexPlayer, indexStartLoc, false, true, false)
            elseif (indexRace == 2) then
                call MeleeStartingUnitsOrc(indexPlayer, indexStartLoc, false, true, false)
            elseif (indexRace == 3) then
                call MeleeStartingUnitsUndead(indexPlayer, indexStartLoc, false, true, false)
            elseif (indexRace == 4) then
                call MeleeStartingUnitsNightElf(indexPlayer, indexStartLoc, false, true, false)
            else
                call MeleeStartingUnitsUnknownRace(indexPlayer, indexStartLoc, false, true, false)
            endif
        endif

        set index = index + 1
        exitwhen index == 13
    endloop
    
endfunction

//===========================================================================


//===========================================================================
function InitTrig_CUSTOM_Melee_FUNC takes nothing returns nothing
endfunction

//===========================================================================
// Trigger: melee init
//===========================================================================
function Trig_melee_init_Func005A takes nothing returns nothing
    call DialogDisplayBJ( true, udg_Dlg_race, GetEnumPlayer() )
endfunction

function Trig_melee_init_Func019A takes nothing returns nothing
    call DialogDisplayBJ( false, udg_Dlg_race, GetEnumPlayer() )
endfunction

function Trig_melee_init_Actions takes nothing returns nothing
    call PauseGameOn(  )
    call InitRaceSelectDialog()
    call DialogSetMessageBJ( udg_Dlg_race, "TRIGSTR_276" )
    call ForForce( GetPlayersAll(), function Trig_melee_init_Func005A )
    call TriggerSleepAction( 1.00 )
    call DialogSetMessageBJ( udg_Dlg_race, "TRIGSTR_278" )
    call DisplayTextToForce( GetPlayersAll(), "TRIGSTR_279" )
    call TriggerSleepAction( 1.00 )
    call DialogSetMessageBJ( udg_Dlg_race, "TRIGSTR_281" )
    call DisplayTextToForce( GetPlayersAll(), "TRIGSTR_282" )
    call TriggerSleepAction( 1.00 )
    call DialogSetMessageBJ( udg_Dlg_race, "TRIGSTR_284" )
    call DisplayTextToForce( GetPlayersAll(), "TRIGSTR_285" )
    call TriggerSleepAction( 0.90 )
    call ForForce( GetPlayersAll(), function Trig_melee_init_Func019A )
    call TriggerSleepAction( 0.10 )
    // ==== ==== ==== ==== ==== ==== ==== ==== ==== ==== ==== ====
    call Custom_MeleeStartingUnits(  )
    call MeleeStartingAI(  )
    call DisplayTextToForce( GetPlayersAll(), "TRIGSTR_286" )
    call PauseGameOff(  )
endfunction

//===========================================================================
function InitTrig_melee_init takes nothing returns nothing
    set gg_trg_melee_init = CreateTrigger(  )
    call TriggerRegisterTimerEventSingle( gg_trg_melee_init, 0.20 )
    call TriggerAddAction( gg_trg_melee_init, function Trig_melee_init_Actions )
endfunction

//===========================================================================
// Trigger: declare variables
//
// udg_Tab12_AllyScore[0-12]
// [0]    用于统计队伍得分的临时变量 用于结盟
// [1-12] 记录个玩家,结盟的队伍得分
// udg_Tab12_AllyState[0-12] 
// [0]    记录当前玩家总数,用于控制最终结盟数量 不少于3个
// [1-12] 记录各个玩家的状态
// = 20  // 初始值
// = 19  // 未死亡(参与游戏)
// = 18  // 击败计时 (已废弃)
// =1-12 // 玩家死亡瞬时 为死亡玩家的编号
// =1-12 // 死亡后记录结盟的任然存活的玩家编号,归属玩家
// =  0  // 离开游戏
// udg_Tab12_keyStructs[0-12]
// [0]      计时器闪烁标志
// [1-12]   1,玩家存活时记录玩家主基地的个数 
// udg_Tab12_AllyGrp[0-12]
// [0]   临时玩家组
// udg_Hero36_Tim[0-36] 
// udg_Hero36_Win[0-36]
// [0]      游戏结束倒计时
// [1-36]   英雄复活倒计时
// udg_LostBase12_Tim[0-12] 
// udg_LostBase12_Win[0-12]
// [0]      毒来到消散倒计时
// [1-12]   玩家rpg倒计时
// udg_CreepRegen2_Loc[0-2]
// [0]      临时用点 1,刚失败的玩家的英雄复活点 2,刷怪点
// [1-2]   刷高级怪的点
//===========================================================================
function Trig_declare_variables_Actions takes nothing returns nothing
    set udg_WeatherEffect[0] = GetLastCreatedWeatherEffect()
    set udg_Poison_Tim = GetLastCreatedTimerBJ()
    set udg_MAP_COLOR[0] = 0
    set udg_MAP_LOC[0] = 0
    set udg_PERM12[0] = 0
endfunction

//===========================================================================
function InitTrig_declare_variables takes nothing returns nothing
    set gg_trg_declare_variables = CreateTrigger(  )
    call TriggerAddAction( gg_trg_declare_variables, function Trig_declare_variables_Actions )
endfunction

//===========================================================================
// Trigger: debug on
//===========================================================================
function Trig_debug_on_Actions takes nothing returns nothing
    call EnableTrigger( gg_trg_debug )
    call EnableTrigger( gg_trg_debug_2 )
    call DisplayTextToForce( GetPlayersAll(), "TRIGSTR_287" )
    call DisableTrigger( GetTriggeringTrigger() )
endfunction

//===========================================================================
function InitTrig_debug_on takes nothing returns nothing
    set gg_trg_debug_on = CreateTrigger(  )
    call TriggerRegisterPlayerChatEvent( gg_trg_debug_on, Player(0), "debug on", true )
    call TriggerRegisterPlayerChatEvent( gg_trg_debug_on, Player(1), "debug on", true )
    call TriggerAddAction( gg_trg_debug_on, function Trig_debug_on_Actions )
endfunction

//===========================================================================
// Trigger: debug
//===========================================================================
function Trig_debug_Func001C takes nothing returns boolean
    if ( not ( SubStringBJ(GetEventPlayerChatString(), 1, 2) == "-d" ) ) then
        return false
    endif
    return true
endfunction

function Trig_debug_Func002C takes nothing returns boolean
    if ( not ( SubStringBJ(GetEventPlayerChatString(), 1, 2) == "-t" ) ) then
        return false
    endif
    return true
endfunction

function Trig_debug_Func003C takes nothing returns boolean
    if ( not ( SubStringBJ(GetEventPlayerChatString(), 1, 2) == "-c" ) ) then
        return false
    endif
    return true
endfunction

function Trig_debug_Func004C takes nothing returns boolean
    if ( not ( SubStringBJ(GetEventPlayerChatString(), 1, 2) == "-s" ) ) then
        return false
    endif
    return true
endfunction

function Trig_debug_Func005C takes nothing returns boolean
    if ( not ( SubStringBJ(GetEventPlayerChatString(), 1, 2) == "-r" ) ) then
        return false
    endif
    return true
endfunction

function Trig_debug_Func006Func004C takes nothing returns boolean
    if ( not ( udg_temp_bool == true ) ) then
        return false
    endif
    return true
endfunction

function Trig_debug_Func006C takes nothing returns boolean
    if ( not ( SubStringBJ(GetEventPlayerChatString(), 1, 2) == "-o" ) ) then
        return false
    endif
    return true
endfunction

function Trig_debug_Actions takes nothing returns nothing
    if ( Trig_debug_Func001C() ) then
        call FogEnableOff(  )
        call FogMaskEnableOff(  )
        call SetPlayerStateBJ( Player(0), PLAYER_STATE_RESOURCE_GOLD, 9999 )
        call SetPlayerStateBJ( Player(0), PLAYER_STATE_RESOURCE_LUMBER, 9999 )
    else
    endif
    if ( Trig_debug_Func002C() ) then
        call TriggerExecute( gg_trg_timer )
    else
    endif
    if ( Trig_debug_Func003C() ) then
        call DisableTrigger( gg_trg_VictoryDefeat )
        call DisplayTextToForce( GetPlayersAll(), "TRIGSTR_288" )
        call PauseTimerBJ( true, udg_GameEnd_Tim )
    else
    endif
    if ( Trig_debug_Func004C() ) then
        call CreateNUnitsAtLoc( 1, 'Uwar', GetTriggerPlayer(), GetPlayerStartLocationLoc(GetTriggerPlayer()), bj_UNIT_FACING )
    else
    endif
    if ( Trig_debug_Func005C() ) then
        call Adjust_Player_Resource( GetEventPlayerChatString() )
    else
    endif
    if ( Trig_debug_Func006C() ) then
        set udg_temp_Ply = ConvertedPlayer(S2I(SubStringBJ(GetEventPlayerChatString(), 3, 4)))
        set udg_temp_Int = GetConvertedPlayerId(GetTriggerPlayer())
        set udg_temp_bool = GetPlayerAlliance( udg_temp_Ply, Player(udg_temp_Int - 1), ALLIANCE_SHARED_ADVANCED_CONTROL)
        if ( Trig_debug_Func006Func004C() ) then
            call SetPlayerAlliance( udg_temp_Ply, Player(udg_temp_Int - 1), ALLIANCE_SHARED_ADVANCED_CONTROL, false)
            call SetPlayerAlliance( udg_temp_Ply, Player(udg_temp_Int - 1), ALLIANCE_SHARED_CONTROL, false)
            call SetPlayerAlliance( udg_temp_Ply, Player(udg_temp_Int - 1), ALLIANCE_SHARED_VISION, false)
        else
            call SetPlayerAlliance( udg_temp_Ply, Player(udg_temp_Int - 1), ALLIANCE_SHARED_ADVANCED_CONTROL, true)
            call SetPlayerAlliance( udg_temp_Ply, Player(udg_temp_Int - 1), ALLIANCE_SHARED_CONTROL, true)
            call SetPlayerAlliance( udg_temp_Ply, Player(udg_temp_Int - 1), ALLIANCE_SHARED_VISION, true)
        endif
    else
    endif
endfunction

//===========================================================================
function InitTrig_debug takes nothing returns nothing
    set gg_trg_debug = CreateTrigger(  )
    call DisableTrigger( gg_trg_debug )
    call TriggerRegisterPlayerChatEvent( gg_trg_debug, Player(0), "-", false )
    call TriggerRegisterPlayerChatEvent( gg_trg_debug, Player(1), "-", false )
    call TriggerAddAction( gg_trg_debug, function Trig_debug_Actions )
endfunction

//===========================================================================
// Trigger: debug 2
//===========================================================================
function Trig_debug_2_Func001C takes nothing returns boolean
    if ( not ( SubStringBJ(GetEventPlayerChatString(), 1, 2) == "-1" ) ) then
        return false
    endif
    return true
endfunction

function Trig_debug_2_Func002C takes nothing returns boolean
    if ( not ( SubStringBJ(GetEventPlayerChatString(), 1, 2) == "-2" ) ) then
        return false
    endif
    return true
endfunction

function Trig_debug_2_Func003C takes nothing returns boolean
    if ( not ( SubStringBJ(GetEventPlayerChatString(), 1, 2) == "-3" ) ) then
        return false
    endif
    return true
endfunction

function Trig_debug_2_Func004C takes nothing returns boolean
    if ( not ( SubStringBJ(GetEventPlayerChatString(), 1, 2) == "-4" ) ) then
        return false
    endif
    return true
endfunction

function Trig_debug_2_Func005C takes nothing returns boolean
    if ( not ( SubStringBJ(GetEventPlayerChatString(), 1, 2) == "-5" ) ) then
        return false
    endif
    return true
endfunction

function Trig_debug_2_Actions takes nothing returns nothing
    if ( Trig_debug_2_Func001C() ) then
        call TriggerExecute( gg_trg_fog )
    else
    endif
    if ( Trig_debug_2_Func002C() ) then
    else
    endif
    if ( Trig_debug_2_Func003C() ) then
        call ConditionalTriggerExecute( gg_trg_check_regen )
    else
    endif
    if ( Trig_debug_2_Func004C() ) then
        set bj_forLoopAIndex = 1
        set bj_forLoopAIndexEnd = 10
        loop
            exitwhen bj_forLoopAIndex > bj_forLoopAIndexEnd
            call KillUnit( udg_CreepsNew20_Uit[GetForLoopIndexA()] )
            set bj_forLoopAIndex = bj_forLoopAIndex + 1
        endloop
    else
    endif
    if ( Trig_debug_2_Func005C() ) then
        call ConditionalTriggerExecute( gg_trg_timer )
    else
    endif
endfunction

//===========================================================================
function InitTrig_debug_2 takes nothing returns nothing
    set gg_trg_debug_2 = CreateTrigger(  )
    call DisableTrigger( gg_trg_debug_2 )
    call TriggerRegisterPlayerChatEvent( gg_trg_debug_2, Player(0), "-", false )
    call TriggerRegisterPlayerChatEvent( gg_trg_debug_2, Player(1), "-", false )
    call TriggerAddAction( gg_trg_debug_2, function Trig_debug_2_Actions )
endfunction

//===========================================================================
// Trigger: init Str after loading
//===========================================================================
function Trig_init_Str_after_loading_Actions takes nothing returns nothing
    // ------分配傀儡ID-------
    set bj_forLoopAIndex = 1
    set bj_forLoopAIndexEnd = 12
    loop
        exitwhen bj_forLoopAIndex > bj_forLoopAIndexEnd
        call SetPlayerName( ConvertedPlayer(GetForLoopIndexA()), udg_Name12_Str[udg_MAP_NAME[GetForLoopIndexA()]] )
        call TimerDialogSetTitleBJ( udg_LostBase12_Win[GetForLoopIndexA()], "TRIGSTR_289" )
        set bj_forLoopAIndex = bj_forLoopAIndex + 1
    endloop
    // ------ ------- -------
    call StartTimerBJ( udg_GameEnd_Tim, false, 2400.00 )
endfunction

//===========================================================================
function InitTrig_init_Str_after_loading takes nothing returns nothing
    set gg_trg_init_Str_after_loading = CreateTrigger(  )
    call TriggerRegisterTimerEventSingle( gg_trg_init_Str_after_loading, 0.10 )
    call TriggerAddAction( gg_trg_init_Str_after_loading, function Trig_init_Str_after_loading_Actions )
endfunction

//===========================================================================
// Trigger: init Quest
//===========================================================================
function Trig_init_Quest_Actions takes nothing returns nothing
    // 地图特点
    call CreateQuestBJ( bj_QUESTTYPE_REQ_DISCOVERED, "TRIGSTR_290", "TRIGSTR_291", "ReplaceableTextures\\CommandButtons\\BTNRallyPoint.blp" )
    call CreateQuestItemBJ( GetLastCreatedQuestBJ(), "TRIGSTR_292" )
    call CreateQuestItemBJ( GetLastCreatedQuestBJ(), "TRIGSTR_293" )
    call CreateQuestItemBJ( GetLastCreatedQuestBJ(), "TRIGSTR_294" )
    call QuestSetDescriptionBJ( GetLastCreatedQuestBJ(), "TRIGSTR_295" )
    call CreateQuestBJ( bj_QUESTTYPE_REQ_DISCOVERED, "TRIGSTR_296", "TRIGSTR_297", "ReplaceableTextures\\CommandButtons\\BTNRallyPoint.blp" )
    call CreateQuestItemBJ( GetLastCreatedQuestBJ(), "TRIGSTR_298" )
    call CreateQuestItemBJ( GetLastCreatedQuestBJ(), "TRIGSTR_299" )
    call CreateQuestItemBJ( GetLastCreatedQuestBJ(), "TRIGSTR_300" )
    call QuestSetDescriptionBJ( GetLastCreatedQuestBJ(), "TRIGSTR_301" )
    // 游戏命令
    call CreateQuestBJ( bj_QUESTTYPE_OPT_DISCOVERED, "TRIGSTR_303", "TRIGSTR_304", "ReplaceableTextures\\CommandButtons\\BTNHolyBolt.blp" )
    call CreateQuestItemBJ( GetLastCreatedQuestBJ(), "TRIGSTR_305" )
    call CreateQuestItemBJ( GetLastCreatedQuestBJ(), "TRIGSTR_306" )
    call CreateQuestItemBJ( GetLastCreatedQuestBJ(), "TRIGSTR_307" )
    // 地图说明
    call CreateQuestBJ( bj_QUESTTYPE_OPT_DISCOVERED, "TRIGSTR_308", "TRIGSTR_309", "ReplaceableTextures\\CommandButtons\\BTNHolyBolt.blp" )
    call CreateQuestItemBJ( GetLastCreatedQuestBJ(), "TRIGSTR_310" )
    call CreateQuestItemBJ( GetLastCreatedQuestBJ(), "TRIGSTR_311" )
    call CreateQuestItemBJ( GetLastCreatedQuestBJ(), "TRIGSTR_312" )
    // 按钮闪亮
    call DisplayTextToForce( GetPlayersAll(), "TRIGSTR_313" )
    call FlashQuestDialogButtonBJ(  )
    call EnableTrigger( gg_trg_gg_command )
endfunction

//===========================================================================
function InitTrig_init_Quest takes nothing returns nothing
    set gg_trg_init_Quest = CreateTrigger(  )
    call TriggerRegisterTimerEventSingle( gg_trg_init_Quest, 10.00 )
    call TriggerAddAction( gg_trg_init_Quest, function Trig_init_Quest_Actions )
endfunction

//===========================================================================
// Trigger: LB hint
//===========================================================================
function Trig_LB_hint_Actions takes nothing returns nothing
    call DisplayTextToForce( GetPlayersAll(), "TRIGSTR_315" )
    call CreateLeaderboardBJ( GetPlayersAll(), "TRIGSTR_316" )
    set udg_Lb_score = GetLastCreatedLeaderboard()
    call TriggerExecute( gg_trg_LB_update )
endfunction

//===========================================================================
function InitTrig_LB_hint takes nothing returns nothing
    set gg_trg_LB_hint = CreateTrigger(  )
    call TriggerRegisterTimerEventSingle( gg_trg_LB_hint, 15.00 )
    call TriggerAddAction( gg_trg_LB_hint, function Trig_LB_hint_Actions )
endfunction

//===========================================================================
// Trigger: LB update
//===========================================================================
function Trig_LB_update_Actions takes nothing returns nothing

    local integer     index
    local integer     itemCount
    local integer     p
    local player      indexPlayer
    local string      label
    local integer     timeSec

    call LeaderboardClear( udg_Lb_score )

    set timeSec = R2I(TimerGetRemaining(udg_GameEnd_Tim))
    set p = timeSec / 60
    call LeaderboardSetLabel(udg_Lb_score, "时间剩余<" + I2S(p) + ":" + I2S(timeSec - 60*p) +">     得分榜")

    set index = 1
    set itemCount = 0
    loop
        set indexPlayer = Player(index-1)

        //if ( GetPlayerSlotState(indexPlayer) == PLAYER_SLOT_STATE_PLAYING  and not IsPlayerObserver(indexPlayer)) then
        if ( udg_Tab12_keyStructs[ index ] >= 10 ) then

            set label = I2S(GetPlayerState(indexPlayer, PLAYER_STATE_RESOURCE_FOOD_USED))+ " <"
            set label = label + I2S(GetHeroLevel(udg_Hero36_Uit[index])) + "_"
            set label = label + I2S(GetHeroLevel(udg_Hero36_Uit[index+12])) + "_"
            set label = label + I2S(GetHeroLevel(udg_Hero36_Uit[index+24]))
            set label = label + "> " +  GetPlayerName(indexPlayer) 
            call LeaderboardAddItem(udg_Lb_score, label, GetPlayerScore(indexPlayer, PLAYER_SCORE_TOTAL), indexPlayer)
    
            set itemCount = itemCount + 1
        endif


        set index = index + 1
        exitwhen index >= 13
    endloop

    call LeaderboardSetSizeByItemCount(udg_Lb_score, itemCount)
    call LeaderboardSortItemsByValue(udg_Lb_score, false)

endfunction

//===========================================================================
function InitTrig_LB_update takes nothing returns nothing
    set gg_trg_LB_update = CreateTrigger(  )
    call TriggerRegisterTimerEventPeriodic( gg_trg_LB_update, 10.00 )
    call TriggerAddAction( gg_trg_LB_update, function Trig_LB_update_Actions )
endfunction

//===========================================================================
// Trigger: LB display
//===========================================================================
function Trig_LB_display_Actions takes nothing returns nothing
    if  GetTriggerPlayer() == GetLocalPlayer() then
    call LeaderboardDisplayBJ( true, udg_Lb_score )
    endif
endfunction

//===========================================================================
function InitTrig_LB_display takes nothing returns nothing
    set gg_trg_LB_display = CreateTrigger(  )
    call TriggerRegisterPlayerKeyEventBJ( gg_trg_LB_display, Player(0), bj_KEYEVENTTYPE_DEPRESS, bj_KEYEVENTKEY_DOWN )
    call TriggerRegisterPlayerKeyEventBJ( gg_trg_LB_display, Player(1), bj_KEYEVENTTYPE_DEPRESS, bj_KEYEVENTKEY_DOWN )
    call TriggerRegisterPlayerKeyEventBJ( gg_trg_LB_display, Player(2), bj_KEYEVENTTYPE_DEPRESS, bj_KEYEVENTKEY_DOWN )
    call TriggerRegisterPlayerKeyEventBJ( gg_trg_LB_display, Player(3), bj_KEYEVENTTYPE_DEPRESS, bj_KEYEVENTKEY_DOWN )
    call TriggerRegisterPlayerKeyEventBJ( gg_trg_LB_display, Player(4), bj_KEYEVENTTYPE_DEPRESS, bj_KEYEVENTKEY_DOWN )
    call TriggerRegisterPlayerKeyEventBJ( gg_trg_LB_display, Player(5), bj_KEYEVENTTYPE_DEPRESS, bj_KEYEVENTKEY_DOWN )
    call TriggerRegisterPlayerKeyEventBJ( gg_trg_LB_display, Player(6), bj_KEYEVENTTYPE_DEPRESS, bj_KEYEVENTKEY_DOWN )
    call TriggerRegisterPlayerKeyEventBJ( gg_trg_LB_display, Player(7), bj_KEYEVENTTYPE_DEPRESS, bj_KEYEVENTKEY_DOWN )
    call TriggerRegisterPlayerKeyEventBJ( gg_trg_LB_display, Player(8), bj_KEYEVENTTYPE_DEPRESS, bj_KEYEVENTKEY_DOWN )
    call TriggerRegisterPlayerKeyEventBJ( gg_trg_LB_display, Player(9), bj_KEYEVENTTYPE_DEPRESS, bj_KEYEVENTKEY_DOWN )
    call TriggerRegisterPlayerKeyEventBJ( gg_trg_LB_display, Player(10), bj_KEYEVENTTYPE_DEPRESS, bj_KEYEVENTKEY_DOWN )
    call TriggerRegisterPlayerKeyEventBJ( gg_trg_LB_display, Player(11), bj_KEYEVENTTYPE_DEPRESS, bj_KEYEVENTKEY_DOWN )
    call TriggerAddAction( gg_trg_LB_display, function Trig_LB_display_Actions )
endfunction

//===========================================================================
// Trigger: LB hide
//===========================================================================
function Trig_LB_hide_Actions takes nothing returns nothing
    if  GetTriggerPlayer() == GetLocalPlayer() then
    call LeaderboardDisplayBJ( false, udg_Lb_score )
    endif
endfunction

//===========================================================================
function InitTrig_LB_hide takes nothing returns nothing
    set gg_trg_LB_hide = CreateTrigger(  )
    call TriggerRegisterPlayerKeyEventBJ( gg_trg_LB_hide, Player(0), bj_KEYEVENTTYPE_DEPRESS, bj_KEYEVENTKEY_UP )
    call TriggerRegisterPlayerKeyEventBJ( gg_trg_LB_hide, Player(1), bj_KEYEVENTTYPE_DEPRESS, bj_KEYEVENTKEY_UP )
    call TriggerRegisterPlayerKeyEventBJ( gg_trg_LB_hide, Player(2), bj_KEYEVENTTYPE_DEPRESS, bj_KEYEVENTKEY_UP )
    call TriggerRegisterPlayerKeyEventBJ( gg_trg_LB_hide, Player(3), bj_KEYEVENTTYPE_DEPRESS, bj_KEYEVENTKEY_UP )
    call TriggerRegisterPlayerKeyEventBJ( gg_trg_LB_hide, Player(4), bj_KEYEVENTTYPE_DEPRESS, bj_KEYEVENTKEY_UP )
    call TriggerRegisterPlayerKeyEventBJ( gg_trg_LB_hide, Player(5), bj_KEYEVENTTYPE_DEPRESS, bj_KEYEVENTKEY_UP )
    call TriggerRegisterPlayerKeyEventBJ( gg_trg_LB_hide, Player(6), bj_KEYEVENTTYPE_DEPRESS, bj_KEYEVENTKEY_UP )
    call TriggerRegisterPlayerKeyEventBJ( gg_trg_LB_hide, Player(7), bj_KEYEVENTTYPE_DEPRESS, bj_KEYEVENTKEY_UP )
    call TriggerRegisterPlayerKeyEventBJ( gg_trg_LB_hide, Player(8), bj_KEYEVENTTYPE_DEPRESS, bj_KEYEVENTKEY_UP )
    call TriggerRegisterPlayerKeyEventBJ( gg_trg_LB_hide, Player(9), bj_KEYEVENTTYPE_DEPRESS, bj_KEYEVENTKEY_UP )
    call TriggerRegisterPlayerKeyEventBJ( gg_trg_LB_hide, Player(10), bj_KEYEVENTTYPE_DEPRESS, bj_KEYEVENTKEY_UP )
    call TriggerRegisterPlayerKeyEventBJ( gg_trg_LB_hide, Player(11), bj_KEYEVENTTYPE_DEPRESS, bj_KEYEVENTKEY_UP )
    call TriggerAddAction( gg_trg_LB_hide, function Trig_LB_hide_Actions )
endfunction

//===========================================================================
// Trigger: flash FCN
//===========================================================================
function FlashEndTimerTitle takes nothing returns nothing 
    local integer     timeSec
    local integer     a
    local integer     b
    local integer     c
    local string Str

    set Str = LeaderboardGetLabelText( udg_Lb_score )
 


    set timeSec = R2I(TimerGetRemaining(udg_GameEnd_Tim))
    set a = timeSec / 60
    set timeSec = timeSec - 60*a
    set b = timeSec / 10
    set c = timeSec - 10*b

    set Str = "时间剩余<" + I2S(a) + ":" + I2S(b) + I2S(c) +">"
    //call LeaderboardSetLabel(udg_Lb_score, "时间剩余<" + I2S(p) + ":" + I2S(timeSec - 60*p) +">     得分榜")


    if udg_Tab12_HeroIndex[0] == 0 then

        call LeaderboardSetLabel(udg_Lb_score, "|Cffffffff" + Str + "|R     得分榜")
        set udg_Tab12_HeroIndex[0] = 1
    else
        call LeaderboardSetLabel(udg_Lb_score, "|Cff00ff00" + Str + "|R     得分榜")
        set udg_Tab12_HeroIndex[0] = 0
    endif


endfunction


//===========================================================================
function InitTrig_flash_FCN takes nothing returns nothing
endfunction

//===========================================================================
// Trigger: share vision
//===========================================================================
function Trig_share_vision_Func013Func001001001001 takes nothing returns boolean
    return ( GetFilterPlayer() != udg_current_Cripple_Ply )
endfunction

function Trig_share_vision_Func013Func001001001002 takes nothing returns boolean
    return ( GetFilterPlayer() != udg_temp_Ply )
endfunction

function Trig_share_vision_Func013Func001001001 takes nothing returns boolean
    return GetBooleanAnd( Trig_share_vision_Func013Func001001001001(), Trig_share_vision_Func013Func001001001002() )
endfunction

function Trig_share_vision_Func013Func006001001 takes nothing returns boolean
    return ( udg_Tab12_keyStructs[GetConvertedPlayerId(GetFilterPlayer())] >= 10 )
endfunction

function Trig_share_vision_Func013Func006A takes nothing returns nothing
    call SetPlayerAllianceBJ( udg_current_Cripple_Ply, ALLIANCE_SHARED_VISION, false, GetEnumPlayer() )
endfunction

function Trig_share_vision_Func013Func009A takes nothing returns nothing
    call SetPlayerAllianceBJ( udg_temp_Ply, ALLIANCE_SHARED_VISION, true, GetEnumPlayer() )
endfunction

function Trig_share_vision_Func013C takes nothing returns boolean
    if ( not ( udg_current_Cripple_Ply != udg_temp_Ply ) ) then
        return false
    endif
    return true
endfunction

function Trig_share_vision_Actions takes nothing returns nothing
    call DestroyEffectBJ( udg_HeroVision3_Eft[1] )
    call DestroyEffectBJ( udg_HeroVision3_Eft[2] )
    call DestroyEffectBJ( udg_HeroVision3_Eft[3] )
    set udg_temp_Ply = LeaderboardGetIndexedPlayerBJ(1, udg_Lb_score)
    set udg_temp_Int = GetConvertedPlayerId(udg_temp_Ply)
    call AddSpecialEffectTargetUnitBJ( "overhead", udg_Hero36_Uit[udg_temp_Int], "Units\\NightElf\\Owl\\Owl.mdl" )
    set udg_HeroVision3_Eft[1] = GetLastCreatedEffectBJ()
    call AddSpecialEffectTargetUnitBJ( "overhead", udg_Hero36_Uit[( udg_temp_Int + 12 )], "Units\\NightElf\\Owl\\Owl.mdl" )
    set udg_HeroVision3_Eft[2] = GetLastCreatedEffectBJ()
    call AddSpecialEffectTargetUnitBJ( "overhead", udg_Hero36_Uit[( udg_temp_Int + 24 )], "Units\\NightElf\\Owl\\Owl.mdl" )
    set udg_HeroVision3_Eft[3] = GetLastCreatedEffectBJ()
    if ( Trig_share_vision_Func013C() ) then
        call DisplayTextToForce( GetPlayersMatching(Condition(function Trig_share_vision_Func013Func001001001)), "TRIGSTR_317" )
        call PingMinimapLocForForceEx( GetPlayersAll(), GetPlayerStartLocationLoc(udg_temp_Ply), 5.00, bj_MINIMAPPINGSTYLE_FLASHY, 100, 100, 100 )
        call DisplayTextToForce( GetForceOfPlayer(udg_current_Cripple_Ply), "TRIGSTR_318" )
        call SetPlayerFlagBJ( PLAYER_STATE_GIVES_BOUNTY, false, udg_current_Cripple_Ply )
        call ForForce( GetPlayersMatching(Condition(function Trig_share_vision_Func013Func006001001)), function Trig_share_vision_Func013Func006A )
        call DisplayTextToForce( GetForceOfPlayer(udg_temp_Ply), "TRIGSTR_319" )
        call SetPlayerFlagBJ( PLAYER_STATE_GIVES_BOUNTY, true, udg_temp_Ply )
        call ForForce( GetPlayersEnemies(udg_temp_Ply), function Trig_share_vision_Func013Func009A )
        set udg_current_Cripple_Ply = udg_temp_Ply
    else
    endif
endfunction

//===========================================================================
function InitTrig_share_vision takes nothing returns nothing
    set gg_trg_share_vision = CreateTrigger(  )
    call TriggerRegisterTimerEventPeriodic( gg_trg_share_vision, 31.00 )
    call TriggerAddAction( gg_trg_share_vision, function Trig_share_vision_Actions )
endfunction

//===========================================================================
// Trigger: timer
//===========================================================================
function Trig_timer_Actions takes nothing returns nothing
    call FogMaskEnableOff(  )
    call FogEnableOff(  )
    // ---------------------
    set udg_Tab12_HeroIndex[0] = 0
    call TimerStart( udg_LostBase12_Tim[0], 1, true, function FlashEndTimerTitle)
    // ---------------------
    set bj_forLoopAIndex = 1
    set bj_forLoopAIndexEnd = 12
    loop
        exitwhen bj_forLoopAIndex > bj_forLoopAIndexEnd
        call SetPlayerName( ConvertedPlayer(GetForLoopIndexA()), udg_PLAYER_NAME[GetForLoopIndexA()] )
        set bj_forLoopAIndex = bj_forLoopAIndex + 1
    endloop
    call DisplayTextToForce( GetPlayersAll(), "TRIGSTR_320" )
endfunction

//===========================================================================
function InitTrig_timer takes nothing returns nothing
    set gg_trg_timer = CreateTrigger(  )
    call TriggerRegisterTimerEventSingle( gg_trg_timer, 2000.00 )
    call TriggerAddAction( gg_trg_timer, function Trig_timer_Actions )
endfunction

//===========================================================================
// Trigger: VictoryDefeat
//===========================================================================
function Trig_VictoryDefeat_Func007A takes nothing returns nothing
    call DisplayTimedTextFromPlayer(GetEnumPlayer(), 0, 0, 60, GetLocalizedString( "PLAYER_DEFEATED" ))
    call StartSoundForPlayerBJ( GetEnumPlayer(), bj_defeatDialogSound )
endfunction

function Trig_VictoryDefeat_Func008A takes nothing returns nothing
    call DisplayTimedTextFromPlayer( GetEnumPlayer() , 0, 0, 60, GetLocalizedString( "PLAYER_VICTORIOUS" ))
    call StartSoundForPlayerBJ( GetEnumPlayer(), bj_victoryDialogSound )
endfunction

function Trig_VictoryDefeat_Func014A takes nothing returns nothing
    call DialogDisplayBJ( true, udg_Dlg_race, GetEnumPlayer() )
endfunction

function Trig_VictoryDefeat_Actions takes nothing returns nothing
    call PauseGameOn(  )
    call TriggerExecute( gg_trg_LB_update )
    set udg_temp_Ply = LeaderboardGetIndexedPlayerBJ(1, udg_Lb_score)
    call DisableTrigger( gg_trg_LB_update )
    call DisableTrigger( gg_trg_PlayerLeft )
    // ---------------------
    call ForForce( GetPlayersEnemies(udg_temp_Ply), function Trig_VictoryDefeat_Func007A )
    call ForForce( GetPlayersAllies(udg_temp_Ply), function Trig_VictoryDefeat_Func008A )
    // ---------------------
    call DialogClearBJ( udg_Dlg_race )
    call DialogSetMessageBJ( udg_Dlg_race, ( GetPlayerName(udg_temp_Ply) + " 胜利了!" ) )
    call DialogAddQuitButton( udg_Dlg_race , true, "Time up，game over", 0 )
    call ForForce( GetPlayersAll(), function Trig_VictoryDefeat_Func014A )
endfunction

//===========================================================================
function InitTrig_VictoryDefeat takes nothing returns nothing
    set gg_trg_VictoryDefeat = CreateTrigger(  )
    call TriggerRegisterTimerExpireEventBJ( gg_trg_VictoryDefeat, udg_GameEnd_Tim )
    call TriggerAddAction( gg_trg_VictoryDefeat, function Trig_VictoryDefeat_Actions )
endfunction

//===========================================================================
// Trigger: init hero minibase
//===========================================================================
function Trig_init_hero_minibase_Actions takes nothing returns nothing
    set udg_MiniBase4_Itm[1] = 'I001'
    set udg_MiniBase4_Itm[2] = 'I002'
    set udg_MiniBase4_Itm[3] = 'I003'
    set udg_MiniBase4_Itm[4] = 'I000'
endfunction

//===========================================================================
function InitTrig_init_hero_minibase takes nothing returns nothing
    set gg_trg_init_hero_minibase = CreateTrigger(  )
    call TriggerAddAction( gg_trg_init_hero_minibase, function Trig_init_hero_minibase_Actions )
endfunction

//===========================================================================
// Trigger: miniBase
//===========================================================================
function Trig_miniBase_Conditions takes nothing returns boolean
    if ( not ( IsUnitType(GetManipulatingUnit(), UNIT_TYPE_HERO) == true ) ) then
        return false
    endif
    return true
endfunction

function Trig_miniBase_Func003Func002C takes nothing returns boolean
    if ( ( GetItemTypeId(GetManipulatedItem()) == 'I001' ) ) then
        return true
    endif
    if ( ( GetItemTypeId(GetManipulatedItem()) == 'I002' ) ) then
        return true
    endif
    if ( ( GetItemTypeId(GetManipulatedItem()) == 'I003' ) ) then
        return true
    endif
    if ( ( GetItemTypeId(GetManipulatedItem()) == 'I000' ) ) then
        return true
    endif
    return false
endfunction

function Trig_miniBase_Func003C takes nothing returns boolean
    if ( not Trig_miniBase_Func003Func002C() ) then
        return false
    endif
    if ( not ( GetItemTypeId(GetManipulatedItem()) != udg_MiniBase4_Itm[udg_MAP_RACE[udg_temp_Int]] ) ) then
        return false
    endif
    return true
endfunction

function Trig_miniBase_Actions takes nothing returns nothing
    set udg_temp_Int = GetConvertedPlayerId(GetTriggerPlayer())
    if ( Trig_miniBase_Func003C() ) then
        call RemoveItem( GetManipulatedItem() )
        call UnitAddItemByIdSwapped( udg_MiniBase4_Itm[udg_MAP_RACE[udg_temp_Int]], GetTriggerUnit() )
    else
        call SetItemDropOnDeathBJ( GetManipulatedItem(), true )
    endif
endfunction

//===========================================================================
function InitTrig_miniBase takes nothing returns nothing
    set gg_trg_miniBase = CreateTrigger(  )
    call TriggerRegisterAnyUnitEventBJ( gg_trg_miniBase, EVENT_PLAYER_UNIT_PICKUP_ITEM )
    call TriggerAddCondition( gg_trg_miniBase, Condition( function Trig_miniBase_Conditions ) )
    call TriggerAddAction( gg_trg_miniBase, function Trig_miniBase_Actions )
endfunction

//===========================================================================
// Trigger: record hero train
//===========================================================================
function Trig_record_hero_train_Conditions takes nothing returns boolean
    if ( not ( IsUnitType(GetTrainedUnit(), UNIT_TYPE_HERO) == true ) ) then
        return false
    endif
    return true
endfunction

function Trig_record_hero_train_Actions takes nothing returns nothing
    set udg_temp_Int = GetConvertedPlayerId(GetOwningPlayer(GetTrainedUnit()))
    set udg_Tab12_HeroIndex[udg_temp_Int] = ( udg_Tab12_HeroIndex[udg_temp_Int] + 12 )
    set udg_temp_Int = ( ( udg_Tab12_HeroIndex[udg_temp_Int] - 12 ) + udg_temp_Int )
    // ---------------------
    set udg_Hero36_Uit[udg_temp_Int] = GetTrainedUnit()
endfunction

//===========================================================================
function InitTrig_record_hero_train takes nothing returns nothing
    set gg_trg_record_hero_train = CreateTrigger(  )
    call TriggerRegisterAnyUnitEventBJ( gg_trg_record_hero_train, EVENT_PLAYER_UNIT_TRAIN_FINISH )
    call TriggerAddCondition( gg_trg_record_hero_train, Condition( function Trig_record_hero_train_Conditions ) )
    call TriggerAddAction( gg_trg_record_hero_train, function Trig_record_hero_train_Actions )
endfunction

//===========================================================================
// Trigger: record hero sell
//===========================================================================
function Trig_record_hero_sell_Conditions takes nothing returns boolean
    if ( not ( IsUnitType(GetSoldUnit(), UNIT_TYPE_HERO) == true ) ) then
        return false
    endif
    return true
endfunction

function Trig_record_hero_sell_Actions takes nothing returns nothing
    set udg_temp_Int = GetConvertedPlayerId(GetOwningPlayer(GetSoldUnit()))
    set udg_Tab12_HeroIndex[udg_temp_Int] = ( udg_Tab12_HeroIndex[udg_temp_Int] + 12 )
    set udg_temp_Int = ( ( udg_Tab12_HeroIndex[udg_temp_Int] - 12 ) + udg_temp_Int )
    // ---------------------
    set udg_Hero36_Uit[udg_temp_Int] = GetSoldUnit()
endfunction

//===========================================================================
function InitTrig_record_hero_sell takes nothing returns nothing
    set gg_trg_record_hero_sell = CreateTrigger(  )
    call TriggerRegisterPlayerUnitEventSimple( gg_trg_record_hero_sell, Player(PLAYER_NEUTRAL_PASSIVE), EVENT_PLAYER_UNIT_SELL )
    call TriggerAddCondition( gg_trg_record_hero_sell, Condition( function Trig_record_hero_sell_Conditions ) )
    call TriggerAddAction( gg_trg_record_hero_sell, function Trig_record_hero_sell_Actions )
endfunction

//===========================================================================
// Trigger: DefeatPlayer FUNC
//===========================================================================
function DefeatPlayerAndOB takes player obPlayer returns nothing
    local integer playerIndex
    local integer index


    set playerIndex = GetPlayerId(obPlayer) + 1

    call PauseTimer( udg_LostBase12_Tim[playerIndex] )
    //call TimerDialogDisplayForPlayerBJ( false, udg_LostBase12_Win[playerIndex], obPlayer )
    if (GetLocalPlayer() == obPlayer) then
        // Use only local code (no net traffic) within this block to avoid desyncs.
        call TimerDialogDisplay(udg_LostBase12_Win[playerIndex], false)
    endif

    set udg_Tab12_keyStructs[playerIndex] = 5

    call DisplayTimedTextFromPlayer(obPlayer, 0, 0, 60, GetLocalizedString( "PLAYER_DEFEATED" ))
    call MakeUnitsPassiveForPlayer( obPlayer )
    // #########################


    call FogModifierStart(CreateFogModifierRect( obPlayer, FOG_OF_WAR_VISIBLE, GetWorldBounds(), true, false))

    //call SetPlayerState(obPlayer, PLAYER_STATE_OBSERVER , 1)

    set index = 0
    loop

        call SetPlayerAlliance( Player(index), obPlayer, ALLIANCE_SHARED_VISION, true )

        set index = index + 1
        exitwhen index == 12
    endloop
    call SetPlayerAlliance( Player(PLAYER_NEUTRAL_AGGRESSIVE), obPlayer, ALLIANCE_SHARED_VISION, false )
    // #########################
endfunction


function DefeatPlayerTimeout takes nothing returns nothing
    local timer expiredTimer = GetExpiredTimer()
    local integer index
    local integer k

    // Determine which player's timer expired.
    set index = 1
    loop
        exitwhen udg_LostBase12_Tim[index] == expiredTimer
        set index = index + 1
        //exitwhen index == 13
    endloop

    call DefeatPlayerAndOB( Player(index - 1) )

endfunction

//===========================================================================
function InitTrig_DefeatPlayer_FUNC takes nothing returns nothing
endfunction

//===========================================================================
// Trigger: LostUnit
//===========================================================================
function Trig_LostUnit_Conditions takes nothing returns boolean
    if ( not ( IsUnitType(GetDyingUnit(), UNIT_TYPE_TOWNHALL) == true ) ) then
        return false
    endif
    return true
endfunction

function Trig_LostUnit_Func004C takes nothing returns boolean
    if ( not ( udg_Tab12_keyStructs[udg_temp_Int] == 10 ) ) then
        return false
    endif
    return true
endfunction

function Trig_LostUnit_Actions takes nothing returns nothing
    set udg_temp_Int = GetConvertedPlayerId(GetTriggerPlayer())
    set udg_Tab12_keyStructs[udg_temp_Int] = ( udg_Tab12_keyStructs[udg_temp_Int] - 1 )
    if ( Trig_LostUnit_Func004C() ) then
        call TimerStart(udg_LostBase12_Tim[udg_temp_Int], 60, false, function DefeatPlayerTimeout)
        call TimerDialogDisplayForPlayerBJ( true, udg_LostBase12_Win[udg_temp_Int], GetTriggerPlayer() )
        call DisplayTimedTextToForce( GetForceOfPlayer(GetTriggerPlayer()), 20.00, "TRIGSTR_322" )
    else
    endif
endfunction

//===========================================================================
function InitTrig_LostUnit takes nothing returns nothing
    set gg_trg_LostUnit = CreateTrigger(  )
    call TriggerRegisterAnyUnitEventBJ( gg_trg_LostUnit, EVENT_PLAYER_UNIT_DEATH )
    call TriggerAddCondition( gg_trg_LostUnit, Condition( function Trig_LostUnit_Conditions ) )
    call TriggerAddAction( gg_trg_LostUnit, function Trig_LostUnit_Actions )
endfunction

//===========================================================================
// Trigger: BuildUnit
//===========================================================================
function Trig_BuildUnit_Conditions takes nothing returns boolean
    if ( not ( IsUnitType(GetConstructingStructure(), UNIT_TYPE_TOWNHALL) == true ) ) then
        return false
    endif
    return true
endfunction

function Trig_BuildUnit_Func005C takes nothing returns boolean
    if ( not ( udg_Tab12_keyStructs[udg_temp_Int] == 11 ) ) then
        return false
    endif
    return true
endfunction

function Trig_BuildUnit_Actions takes nothing returns nothing
    set udg_temp_Int = GetConvertedPlayerId(GetTriggerPlayer())
    set udg_Tab12_keyStructs[udg_temp_Int] = ( udg_Tab12_keyStructs[udg_temp_Int] + 1 )
    if ( Trig_BuildUnit_Func005C() ) then
        call PauseTimerBJ( true, udg_LostBase12_Tim[udg_temp_Int] )
        call TimerDialogDisplayForPlayerBJ( false, udg_LostBase12_Win[udg_temp_Int], GetTriggerPlayer() )
        call DisplayTimedTextToForce( GetForceOfPlayer(GetTriggerPlayer()), 20.00, "TRIGSTR_323" )
    else
    endif
endfunction

//===========================================================================
function InitTrig_BuildUnit takes nothing returns nothing
    set gg_trg_BuildUnit = CreateTrigger(  )
    call TriggerRegisterAnyUnitEventBJ( gg_trg_BuildUnit, EVENT_PLAYER_UNIT_CONSTRUCT_START )
    call TriggerAddCondition( gg_trg_BuildUnit, Condition( function Trig_BuildUnit_Conditions ) )
    call TriggerAddAction( gg_trg_BuildUnit, function Trig_BuildUnit_Actions )
endfunction

//===========================================================================
// Trigger: gg command
//===========================================================================
function Trig_gg_command_Actions takes nothing returns nothing
    call DefeatPlayerAndOB( GetTriggerPlayer() )
    // #########################
endfunction

//===========================================================================
function InitTrig_gg_command takes nothing returns nothing
    set gg_trg_gg_command = CreateTrigger(  )
    call DisableTrigger( gg_trg_gg_command )
    call TriggerAddAction( gg_trg_gg_command, function Trig_gg_command_Actions )
endfunction

//===========================================================================
// Trigger: PlayerLeft
//===========================================================================
function Trig_PlayerLeft_Actions takes nothing returns nothing
    set udg_temp_Ply = GetTriggerPlayer()
    set udg_temp_Int = GetConvertedPlayerId(udg_temp_Ply)
    call DisplayTimedTextToForce( GetPlayersAll(), 60.00, ( udg_PLAYER_NAME[udg_temp_Int] + "已经离开游戏。" ) )
    set udg_Tab12_keyStructs[udg_temp_Int] = 0
    call MakeUnitsPassiveForPlayer( udg_temp_Ply )
    // #########################
    // ---------------------
endfunction

//===========================================================================
function InitTrig_PlayerLeft takes nothing returns nothing
    set gg_trg_PlayerLeft = CreateTrigger(  )
    call TriggerAddAction( gg_trg_PlayerLeft, function Trig_PlayerLeft_Actions )
endfunction

//===========================================================================
// Trigger: fog FCN
//===========================================================================
function init_CineFilter takes nothing returns nothing
    call SetCineFilterTexture("ReplaceableTextures\\CameraMasks\\DreamFilter_Mask.blp")
    call SetCineFilterBlendMode(BLEND_MODE_ADDITIVE)
    call SetCineFilterTexMapFlags(TEXMAP_FLAG_NONE)
    call SetCineFilterStartUV(0, 0, 1, 1)
    call SetCineFilterEndUV(0, 0, 1, 1)
    call SetCineFilterDuration(1.5)

    call SetCineFilterStartColor(255, 0, 0, 255)
    call SetCineFilterEndColor(255, 0, 0, 0)
endfunction

function FormatFogTimingBar takes integer fp_n returns string
    local string str = ""

    if ( fp_n <= 0 ) then
        return str
    endif

    loop
        exitwhen fp_n < 10

        set str = str + "llllllllll"

        set fp_n = fp_n - 10
    endloop

    loop
        exitwhen fp_n <= 0

        set str = str + "l"

        set fp_n = fp_n - 1
    endloop

    return str
endfunction

//

//===========================================================================
function InitTrig_fog_FCN takes nothing returns nothing
endfunction

//===========================================================================
// Trigger: init fog
//===========================================================================
function Trig_init_fog_Actions takes nothing returns nothing
    set udg_maxMapEdge = 8000.00
    set udg_safeAreaX = 0.00
    set udg_safeAreaY = 0.00
    // 7次缩毒 每次 半径缩小4*128
    set udg_safeAreaM = ( 12 + ( 7 * 4 ) )
    set udg_safeAreaM = 40
    set udg_safeAreaR = ( 128.00 * I2R(udg_safeAreaM) )
    set udg_safeAreaR = 5120.00
    // safeAreaR/safeAreaM == 64
    // 每加个桩半径可以增加64,半径增加1024,要再加16个桩
    call init_CineFilter()
    set udg_MBoard = CreateMultiboard()
endfunction

//===========================================================================
function InitTrig_init_fog takes nothing returns nothing
    set gg_trg_init_fog = CreateTrigger(  )
    call TriggerAddAction( gg_trg_init_fog, function Trig_init_fog_Actions )
endfunction

//===========================================================================
// Trigger: poison FCN
//===========================================================================
function IsPointOutCircle takes real x, real y, real r returns boolean
    local real dx = x - udg_safeAreaX
    local real dy = y - udg_safeAreaY
    return SquareRoot(dx * dx + dy * dy) > r
endfunction

function IsUnitShouldBePoison takes nothing returns boolean

    if ( GetUnitPointValue(GetFilterUnit()) == 5  ) then
        return true
    elseif ( IsUnitType(GetFilterUnit(), UNIT_TYPE_STRUCTURE)  ) then
        return false
    elseif ( IsUnitType(GetFilterUnit(), UNIT_TYPE_PEON)       ) then
        return false
    elseif ( not  IsPointOutCircle(GetUnitX(GetFilterUnit()), GetUnitY(GetFilterUnit()), udg_safeAreaR )  ) then
        return false
    //elseif ( GetUnitDefaultMoveSpeed(GetFilterUnit()) < 10  ) then
        //return false
    elseif ( GetUnitAbilityLevel(GetFilterUnit(), 'Bvul') > 0     ) then
        return false
    //elseif ( GetPlayerController(GetOwningPlayer(GetFilterUnit())) != MAP_CONTROL_USER  ) then
        //return false

    //elseif ( GetUnitFoodUsed(GetFilterUnit()) < 1  ) then
        //return false
    else
        return true
    endif
endfunction

function PoisonUnit takes nothing returns nothing
    local real unitLife = GetUnitState(GetEnumUnit(),UNIT_STATE_LIFE )
    local real unitMana = GetUnitState(GetEnumUnit(),UNIT_STATE_MANA )
    //local real unitMaxMana = GetUnitState(GetEnumUnit(),UNIT_STATE_MAX_MANA )

    call SetUnitState( GetEnumUnit(), UNIT_STATE_LIFE, 0.85*unitLife )
    call SetUnitState( GetEnumUnit(), UNIT_STATE_MANA, 0.8*unitMana )

endfunction

//-----------------------------------------------------------------------

function PoisonMilitary takes nothing returns nothing
    local integer index
    local player  indexPlayer
    local group g = CreateGroup()


    set index = 0 
    loop 
        set indexPlayer = Player(index)
        //if (GetPlayerSlotState(indexPlayer) == PLAYER_SLOT_STATE_PLAYING and GetPlayerController(indexPlayer) == MAP_CONTROL_USER) then
        if ( udg_Tab12_keyStructs[ index+1 ] >= 10 and GetPlayerController(indexPlayer) == MAP_CONTROL_USER )  then

            call GroupEnumUnitsOfPlayer(g, indexPlayer, Filter(function IsUnitShouldBePoison) )
            call ForGroup( g, function PoisonUnit)
            call GroupClear( g )

        endif

        set index = index + 1
        exitwhen index == 12
    endloop
    call DestroyGroup( g )

endfunction


function PoisonPlayer takes nothing returns nothing
    local integer index
    set index = 0 
    loop 

        if ( GetLocalPlayer() == Player(index) ) then 
            if ( IsPointOutCircle(GetCameraTargetPositionX(), GetCameraTargetPositionY(), udg_safeAreaR +250) ) then

                call DisplayCineFilter(true)

            endif
        endif

        set index = index + 1
        exitwhen index == 12
    endloop

endfunction


function PoisonEffect  takes nothing returns nothing

    call PoisonMilitary()
    call PoisonPlayer()

endfunction
//===========================================================================
function InitTrig_poison_FCN takes nothing returns nothing
endfunction

//===========================================================================
// Trigger: fog dispersed
//===========================================================================
function EndFog takes nothing returns nothing
    local integer index

    call EnableWeatherEffect( udg_WeatherEffect[1], false )
    call EnableWeatherEffect( udg_WeatherEffect[2], false )
    call EnableWeatherEffect( udg_WeatherEffect[3], false )
    call EnableWeatherEffect( udg_WeatherEffect[4], false )
    call EnableWeatherEffect( udg_WeatherEffect[5], false )
    call EnableWeatherEffect( udg_WeatherEffect[6], false )
    call EnableWeatherEffect( udg_WeatherEffect[7], false )
    call EnableWeatherEffect( udg_WeatherEffect[8], false )

    call RemoveWeatherEffect( udg_WeatherEffect[1] )
    call RemoveWeatherEffect( udg_WeatherEffect[2] )
    call RemoveWeatherEffect( udg_WeatherEffect[3] )
    call RemoveWeatherEffect( udg_WeatherEffect[4] )
    call RemoveWeatherEffect( udg_WeatherEffect[5] )
    call RemoveWeatherEffect( udg_WeatherEffect[6] )
    call RemoveWeatherEffect( udg_WeatherEffect[7] )
    call RemoveWeatherEffect( udg_WeatherEffect[8] )

    set index = 1
    loop

        call RemoveUnit(udg_FogEdge64_Uit[index])

        set index = index + 1
        exitwhen index > udg_safeAreaM
    endloop


    call MultiboardDisplay( udg_MBoard, false)
    call PauseTimer( udg_Poison_Tim)
    call DisplayTextToPlayer(GetLocalPlayer(), 0, 0, "毒雾已经消散,游戏正常继续" )

endfunction

//===========================================================================
function InitTrig_fog_dispersed takes nothing returns nothing
endfunction

//===========================================================================
// Trigger: fog start
//===========================================================================
function ShowFog takes nothing returns nothing
    local integer x1
    local integer x2
    local integer x3
    local integer x4
    local integer y1
    local integer y2
    local integer y3
    local integer y4
    local real padA = 384
    local real padB = 256

    set x1 = R2I(udg_safeAreaX-udg_safeAreaR-padA)/512*512 - 256
    set x4 = R2I(udg_safeAreaX+udg_safeAreaR+padA)/512*512 + 256
    set y1 = R2I(udg_safeAreaY-udg_safeAreaR-padA)/512*512 - 256
    set y4 = R2I(udg_safeAreaY+udg_safeAreaR+padA)/512*512 + 256

    set x2 = R2I(udg_safeAreaX-udg_safeAreaR/1.41-padB)/512*512 - 256
    set x3 = R2I(udg_safeAreaX+udg_safeAreaR/1.41+padB)/512*512 + 256
    set y2 = R2I(udg_safeAreaY-udg_safeAreaR/1.41-padB)/512*512 - 256
    set y3 = R2I(udg_safeAreaY+udg_safeAreaR/1.41+padB)/512*512 + 256

    //call DisplayTextToForce( GetPlayersAll(), I2S(x1) + "-" + I2S(x4) + "+" + I2S(y1) + "-" + I2S(y4) )
    set udg_WeatherEffect[1] = AddWeatherEffect( Rect( -udg_maxMapEdge, y3, x2, udg_maxMapEdge), 'FDrh' )
    set udg_WeatherEffect[2] = AddWeatherEffect( Rect( -udg_maxMapEdge, -udg_maxMapEdge, x2, y2), 'FDrh' )

    set udg_WeatherEffect[3] = AddWeatherEffect( Rect( x3, y3, udg_maxMapEdge, udg_maxMapEdge), 'FDrh' )
    set udg_WeatherEffect[4] = AddWeatherEffect( Rect( x3, -udg_maxMapEdge, udg_maxMapEdge, y2), 'FDrh' )

    set udg_WeatherEffect[5] = AddWeatherEffect( Rect( x2, y4, x3, udg_maxMapEdge), 'FDrh' )
    set udg_WeatherEffect[6] = AddWeatherEffect( Rect( x2, -udg_maxMapEdge, x3, y1), 'FDrh' )

    set udg_WeatherEffect[7] = AddWeatherEffect( Rect( -udg_maxMapEdge, y2, x1, y3), 'FDrh' )
    set udg_WeatherEffect[8] = AddWeatherEffect( Rect( x4, y2, udg_maxMapEdge, y3), 'FDrh' )

    call EnableWeatherEffect( udg_WeatherEffect[1], true )
    call EnableWeatherEffect( udg_WeatherEffect[2], true )
    call EnableWeatherEffect( udg_WeatherEffect[3], true )
    call EnableWeatherEffect( udg_WeatherEffect[4], true )

    call EnableWeatherEffect( udg_WeatherEffect[5], true )
    call EnableWeatherEffect( udg_WeatherEffect[6], true )
    call EnableWeatherEffect( udg_WeatherEffect[7], true )
    call EnableWeatherEffect( udg_WeatherEffect[8], true )
endfunction

//-----------------------------------------------------------------------
function UpdateFogDispersingBar takes nothing returns nothing

    local string strTT1
    local string strTT2


    set strTT1 = "|Cffe0e0e0" + FormatFogTimingBar( udg_Tab12_keyStructs[0] ) + "|R"
    set strTT2 = "|Cff0090e0" + FormatFogTimingBar( 80 - udg_Tab12_keyStructs[0] ) + "|R"
    call MultiboardSetTitleText( udg_MBoard, "毒雾即将消散  " + strTT1 + strTT2 )

    if udg_Tab12_keyStructs[0] - (udg_Tab12_keyStructs[0] / 10) * 10 == 0 then
        call PoisonEffect()
    endif

    set udg_Tab12_keyStructs[0] = udg_Tab12_keyStructs[0] + 1 

    if udg_Tab12_keyStructs[0] == 81 then
        call EndFog()
    endif
endfunction

//-----------------------------------------------------------------------
function StartPoison takes nothing returns nothing

    call ShowFog()

    set udg_Tab12_keyStructs[0] = 0
    call TimerStart( udg_Poison_Tim, 0.5, true, function UpdateFogDispersingBar)

endfunction

//===========================================================================
//===========================================================================
function InitTrig_fog_start takes nothing returns nothing
endfunction

//===========================================================================
// Trigger: fog coming
//===========================================================================
function WarningPingHint takes nothing returns nothing
    local integer index

    set index = 0 
    loop 

        if ( GetLocalPlayer() == Player(index) ) then 
        // Use only local code (no net traffic) within this block to avoid desyncs.

            call PingMinimapEx(udg_safeAreaX, udg_safeAreaY, 5, 0, 255, 0, true)

        endif

        set index = index + 1
        exitwhen index == 12
    endloop
endfunction

function ShowBorder takes nothing returns nothing
    local integer index
    local real R
    local real D
    //local real rad

    //call SetAltMinimapIcon( "UI\\Minimap\\MinimapIconCircleOfPower.blp" )

    set R = udg_safeAreaR
    set index = 1
    loop
        set D = 6.28319*index/udg_safeAreaM   

        set udg_FogEdge64_Uit[index] = CreateUnit( Player(bj_PLAYER_NEUTRAL_EXTRA), 'n002', udg_safeAreaX+R*Cos(D), udg_safeAreaY+R*Sin(D), 360*index/udg_safeAreaM)

        //call UnitSetUsesAltIcon( udg_FogEdge64_Uit[index], true)
        //call SetUnitPathing( udg_FogEdge64_Uit[index], false )

        set index = index + 1
        exitwhen index > udg_safeAreaM
    endloop

endfunction

//-----------------------------------------------------------------------
function UpdateFogComingBar takes nothing returns nothing

    local string strTT1
    local string strTT2


    set strTT1 = "|Cff0090e0" + FormatFogTimingBar( udg_Tab12_keyStructs[0] ) + "|R"
    set strTT2 = "|Cffe0e0e0" + FormatFogTimingBar( 80 - udg_Tab12_keyStructs[0] ) + "|R"
    call MultiboardSetTitleText( udg_MBoard, "|Cffff0000毒雾即将来袭|R  " + strTT1 + strTT2 )

    set udg_Tab12_keyStructs[0] = udg_Tab12_keyStructs[0] + 1 
    
    if udg_Tab12_keyStructs[0] == 81 then
        call StartPoison()
    endif
endfunction
//-----------------------------------------------------------------------
function StartWarning takes nothing returns nothing

    call WarningPingHint()
    call ShowBorder()

    call MultiboardDisplay( udg_MBoard, true)
    call MultiboardMinimize( udg_MBoard, true)
    //call MultiboardSetColumnCount( udg_MBoard , 0)
    //call MultiboardSetRowCount( udg_MBoard , 0)

    set udg_Tab12_keyStructs[0] = 0
    call TimerStart( udg_Poison_Tim, 0.5, true, function UpdateFogComingBar)

endfunction


//===========================================================================
function InitTrig_fog_coming takes nothing returns nothing
endfunction

//===========================================================================
// Trigger: fog
//
// 关于毒边界单位的设定
// 不加蝗虫技能,会被空军挤开
// 类型设置成飞行的,高度会受树林影响,设置其他的会被树林挤开,只能设置成没有,此时单位高度设置无效
//===========================================================================
function Trig_fog_Conditions takes nothing returns boolean
    if ( not ( GetUnitStateSwap(UNIT_STATE_LIFE, udg_FogEdge64_Uit[udg_safeAreaM]) <= 0.00 ) ) then
        return false
    endif
    if ( not ( GetTriggerEvalCount(GetTriggeringTrigger()) > 1 ) ) then
        return false
    endif
    if ( not ( udg_safeAreaR > 1500.00 ) ) then
        return false
    endif
    if ( not ( udg_safeAreaM > 13 ) ) then
        return false
    endif
    return true
endfunction

function Trig_fog_Actions takes nothing returns nothing
    set udg_safeAreaM = ( udg_safeAreaM - 4 )
    set udg_safeAreaR = ( udg_safeAreaR - 512.00 )
    // 4 - 512    5 - 640   6 -768
    call DisplayTextToForce( GetPlayersAll(), "TRIGSTR_324" )
    call StartWarning()
endfunction

//===========================================================================
function InitTrig_fog takes nothing returns nothing
    set gg_trg_fog = CreateTrigger(  )
    call TriggerRegisterTimerEventPeriodic( gg_trg_fog, 270.00 )
    call TriggerAddCondition( gg_trg_fog, Condition( function Trig_fog_Conditions ) )
    call TriggerAddAction( gg_trg_fog, function Trig_fog_Actions )
endfunction

//===========================================================================
// Trigger: init creep
//===========================================================================
function Trig_init_creep_Func008A takes nothing returns nothing
    set udg_CreepsNew20_Uit[udg_temp_Int] = GetEnumUnit()
    set udg_temp_Int = ( udg_temp_Int + 1 )
endfunction

function Trig_init_creep_Func010A takes nothing returns nothing
    set udg_CreepsNew20_Uit[udg_temp_Int] = GetEnumUnit()
    set udg_temp_Int = ( udg_temp_Int + 1 )
endfunction

function Trig_init_creep_Func012A takes nothing returns nothing
    set udg_CreepsNew20_Uit[udg_temp_Int] = GetEnumUnit()
    set udg_temp_Int = ( udg_temp_Int + 1 )
endfunction

function Trig_init_creep_Actions takes nothing returns nothing
    call SetAltMinimapIcon( "UI\\Minimap\\minimapIcon\\MinimapIconStartLoc.blp" )
    // -----------
    set udg_CreepRegen4_Loc[1] = GetUnitLoc(gg_unit_nogl_0054)
    set udg_CreepRegen4_Loc[2] = GetUnitLoc(gg_unit_nogl_0072)
    set udg_CreepRegen4_Loc[3] = GetUnitLoc(gg_unit_nogl_0067)
    set udg_temp_Int = 1
    call ForGroupBJ( GetUnitsInRectAll(RectFromCenterSizeBJ(udg_CreepRegen4_Loc[1], 600.00, 600.00)), function Trig_init_creep_Func008A )
    set udg_temp_Int = 6
    call ForGroupBJ( GetUnitsInRectAll(RectFromCenterSizeBJ(udg_CreepRegen4_Loc[2], 600.00, 600.00)), function Trig_init_creep_Func010A )
    set udg_temp_Int = 11
    call ForGroupBJ( GetUnitsInRectAll(RectFromCenterSizeBJ(udg_CreepRegen4_Loc[3], 600.00, 600.00)), function Trig_init_creep_Func012A )
    // -----------
    set udg_CreepRegen10_Typ[1] = 'nggr'
    set udg_CreepRegen10_Typ[2] = 'nogl'
    set udg_CreepRegen10_Typ[3] = 'nftk'
    set udg_CreepRegen10_Typ[4] = 'nomg'
    set udg_CreepRegen10_Typ[5] = 'nfsh'
    set udg_CreepRegen10_Typ[6] = 'nggr'
    set udg_CreepRegen10_Typ[7] = 'nogl'
    set udg_CreepRegen10_Typ[8] = 'nftk'
    set udg_CreepRegen10_Typ[9] = 'nomg'
    set udg_CreepRegen10_Typ[10] = 'nfsh'
    // -----------
    set udg_CreepRegen20_Itm[1] = 'lgdh'
    set udg_CreepRegen20_Itm[2] = 'kpin'
    set udg_CreepRegen20_Itm[3] = 'ajen'
    set udg_CreepRegen20_Itm[4] = 'ward'
    set udg_CreepRegen20_Itm[5] = 'ssil'
    set udg_CreepRegen20_Itm[6] = 'odef'
    set udg_CreepRegen20_Itm[7] = 'spsh'
    set udg_CreepRegen20_Itm[8] = 'ratc'
    set udg_CreepRegen20_Itm[9] = 'rde3'
    set udg_CreepRegen20_Itm[11] = 'pmna'
    set udg_CreepRegen20_Itm[12] = 'rhth'
    set udg_CreepRegen20_Itm[13] = 'hlst'
    set udg_CreepRegen20_Itm[14] = 'mnst'
    set udg_CreepRegen20_Itm[15] = 'pnvu'
    set udg_CreepRegen20_Itm[16] = 'pghe'
    set udg_CreepRegen20_Itm[17] = 'pgma'
    set udg_CreepRegen20_Itm[18] = 'rej5'
endfunction

//===========================================================================
function InitTrig_init_creep takes nothing returns nothing
    set gg_trg_init_creep = CreateTrigger(  )
    call TriggerAddAction( gg_trg_init_creep, function Trig_init_creep_Actions )
endfunction

//===========================================================================
// Trigger: check regen
//===========================================================================
function Trig_creeps_regen_Conditions takes nothing returns boolean
    local integer Tcount = GetTriggerEvalCount(GetTriggeringTrigger())
    local integer temp_Int

    set temp_Int = 5 * ( Tcount-(Tcount/3)*3 ) + 1

    if ( GetUnitState(udg_CreepsNew20_Uit[temp_Int], UNIT_STATE_LIFE ) > 0.00  ) then
        return false
    elseif ( GetUnitState(udg_CreepsNew20_Uit[ temp_Int + 1 ], UNIT_STATE_LIFE ) > 0.00  ) then
        return false
    elseif ( GetUnitState(udg_CreepsNew20_Uit[ temp_Int + 2 ], UNIT_STATE_LIFE ) > 0.00  ) then
        return false
    elseif ( GetUnitState(udg_CreepsNew20_Uit[ temp_Int + 3 ], UNIT_STATE_LIFE ) > 0.00  ) then
        return false
    elseif ( GetUnitState(udg_CreepsNew20_Uit[ temp_Int + 4 ], UNIT_STATE_LIFE ) > 0.00  ) then
        return false
    endif

    set udg_temp_Int = temp_Int
    return true

endfunction

function Trig_check_regen_Func_all_dead takes nothing returns boolean
    if ( GetUnitState(udg_CreepsNew20_Uit[udg_temp_Int], UNIT_STATE_LIFE ) > 0.00  ) then
        return false
    endif
    if ( GetUnitState(udg_CreepsNew20_Uit[( udg_temp_Int + 1 )], UNIT_STATE_LIFE ) > 0.00  ) then
        return false
    endif
    if ( GetUnitState(udg_CreepsNew20_Uit[( udg_temp_Int + 2 )], UNIT_STATE_LIFE ) > 0.00  ) then
        return false
    endif
    if ( GetUnitState(udg_CreepsNew20_Uit[( udg_temp_Int + 3 )], UNIT_STATE_LIFE ) > 0.00  ) then
        return false
    endif
    if ( GetUnitState(udg_CreepsNew20_Uit[( udg_temp_Int + 4 )], UNIT_STATE_LIFE ) > 0.00  ) then
        return false
    endif
    return true
endfunction

function Trig_check_regen_Actions takes nothing returns nothing
    local unit    newUnit
    local real    x
    local real    y


        set x = GetRandomReal(-2560, 2560)
        set y = GetRandomReal(-2560, 2560)

        set newUnit = CreateUnit(Player(bj_PLAYER_NEUTRAL_EXTRA), 'nmdm', x, y, 0)
        call SetUnitUserData( newUnit, udg_temp_Int )
        call UnitSetUsesAltIcon( newUnit,  true )
        call IssueImmediateOrder( newUnit, "unravenform" )

        call PingMinimapForForceEx( GetPlayersAll(), x, y, 3.00, bj_MINIMAPPINGSTYLE_FLASHY, 90.00, 90.00, 0.00 )

        call TriggerRegisterUnitEvent( gg_trg_hint_die, newUnit, EVENT_UNIT_DEATH )
        //call DisplayTextToForce( GetPlayersAll(), "TRIGSTR_191" )
        call DisplayTextToForce( GetPlayersAll(), "|Cfffed312警告!携带高级宝物的野怪马上到来!|R" )
    //else
    //endif
    // ======== ======== ======== ======== 
endfunction

//===========================================================================
function InitTrig_check_regen takes nothing returns nothing
    set gg_trg_check_regen = CreateTrigger(  )
    //call TriggerRegisterPlayerKeyEventBJ( gg_trg_check_regen, Player(0), bj_KEYEVENTTYPE_DEPRESS, bj_KEYEVENTKEY_LEFT )
    call TriggerRegisterTimerEventPeriodic( gg_trg_check_regen, 40.00 )
    call TriggerAddCondition( gg_trg_check_regen, Condition( function Trig_creeps_regen_Conditions ) )
    call TriggerAddAction( gg_trg_check_regen, function Trig_check_regen_Actions )
endfunction

//===========================================================================
// Trigger: hint die
//===========================================================================
function Trig_hint_die_______u_Actions takes nothing returns nothing
    local integer temp_Int
    local location Loc

    set temp_Int = GetUnitUserData(GetDyingUnit())
    //set Loc = udg_CreepRegen4_Loc[temp_Int]

    set Loc = GetUnitLoc(GetDyingUnit())

    //set temp_Int = 5 * temp_Int  - 4 

    set udg_CreepsNew20_Uit[temp_Int] = CreateUnitAtLoc( Player(PLAYER_NEUTRAL_AGGRESSIVE), udg_CreepRegen10_Typ[1],  Loc, 270)
    call SetUnitAcquireRange( udg_CreepsNew20_Uit[temp_Int], 200.00 )
    call TriggerRegisterUnitEvent( gg_trg_creep_die, udg_CreepsNew20_Uit[temp_Int], EVENT_UNIT_DEATH )
    //call SetAltMinimapIcon( "UI\\Minimap\\minimapIcon\\MinimapIconStartLoc.blp" )
    call UnitSetUsesAltIcon( udg_CreepsNew20_Uit[temp_Int], true )

    set temp_Int = temp_Int + 1 
    set udg_CreepsNew20_Uit[temp_Int] = CreateUnitAtLoc( Player(PLAYER_NEUTRAL_AGGRESSIVE), udg_CreepRegen10_Typ[2],  Loc, 270)
    call SetUnitAcquireRange( udg_CreepsNew20_Uit[temp_Int], 200.00 )
    call TriggerRegisterUnitEvent( gg_trg_creep_die, udg_CreepsNew20_Uit[temp_Int], EVENT_UNIT_DEATH )

    set temp_Int = temp_Int + 1 
    set udg_CreepsNew20_Uit[temp_Int] = CreateUnitAtLoc( Player(PLAYER_NEUTRAL_AGGRESSIVE), udg_CreepRegen10_Typ[3],  Loc, 270)
    call SetUnitAcquireRange( udg_CreepsNew20_Uit[temp_Int], 200.00 )
    call TriggerRegisterUnitEvent( gg_trg_creep_die, udg_CreepsNew20_Uit[temp_Int], EVENT_UNIT_DEATH )

    set temp_Int = temp_Int + 1 
    set udg_CreepsNew20_Uit[temp_Int] = CreateUnitAtLoc( Player(PLAYER_NEUTRAL_AGGRESSIVE), udg_CreepRegen10_Typ[4],  Loc, 270)
    call SetUnitAcquireRange( udg_CreepsNew20_Uit[temp_Int], 200.00 )

    set temp_Int = temp_Int + 1 
    set udg_CreepsNew20_Uit[temp_Int] = CreateUnitAtLoc( Player(PLAYER_NEUTRAL_AGGRESSIVE), udg_CreepRegen10_Typ[5],  Loc, 270)
    call SetUnitAcquireRange( udg_CreepsNew20_Uit[temp_Int], 200.00 )

    // ======== ======== ======== ======== 
    call RemoveLocation( Loc )
endfunction

//===========================================================================
function InitTrig_hint_die takes nothing returns nothing
    set gg_trg_hint_die = CreateTrigger(  )
    call TriggerAddAction( gg_trg_hint_die, function Trig_hint_die_______u_Actions )
endfunction

//===========================================================================
// Trigger: creep die
//===========================================================================
function Trig_creep_die_Func002C takes nothing returns boolean
    if ( not ( udg_temp_Int > 8 ) ) then
        return false
    endif
    return true
endfunction

function Trig_creep_die_Func003C takes nothing returns boolean
    if ( not ( udg_temp_Int == 7 ) ) then
        return false
    endif
    return true
endfunction

function Trig_creep_die_Func004C takes nothing returns boolean
    if ( not ( udg_temp_Int == 6 ) ) then
        return false
    endif
    return true
endfunction

function Trig_creep_die_Actions takes nothing returns nothing
    set udg_temp_Int = GetUnitLevel(GetTriggerUnit())
    if ( Trig_creep_die_Func002C() ) then
        call CreateItemLoc( udg_CreepRegen20_Itm[GetRandomInt(1, 9)], GetUnitLoc(GetTriggerUnit()) )
        call CreateItemLoc( udg_CreepRegen20_Itm[GetRandomInt(11, 18)], GetUnitLoc(GetTriggerUnit()) )
    else
    endif
    if ( Trig_creep_die_Func003C() ) then
        call CreateItemLoc( udg_CreepRegen20_Itm[GetRandomInt(1, 9)], GetUnitLoc(GetTriggerUnit()) )
    else
    endif
    if ( Trig_creep_die_Func004C() ) then
        call CreateItemLoc( udg_CreepRegen20_Itm[GetRandomInt(11, 18)], GetUnitLoc(GetTriggerUnit()) )
    else
    endif
endfunction

//===========================================================================
function InitTrig_creep_die takes nothing returns nothing
    set gg_trg_creep_die = CreateTrigger(  )
    call TriggerAddAction( gg_trg_creep_die, function Trig_creep_die_Actions )
endfunction

//===========================================================================
function InitCustomTriggers takes nothing returns nothing
    call InitTrig_init_variable(  )
    call InitTrig_init_player(  )
    call InitTrig_init_game(  )
    call InitTrig_InitRaceSelectDialog_FUNC(  )
    call InitTrig_CUSTOM_Melee_FUNC(  )
    call InitTrig_melee_init(  )
    call InitTrig_declare_variables(  )
    call InitTrig_debug_on(  )
    call InitTrig_debug(  )
    call InitTrig_debug_2(  )
    call InitTrig_init_Str_after_loading(  )
    call InitTrig_init_Quest(  )
    call InitTrig_LB_hint(  )
    call InitTrig_LB_update(  )
    call InitTrig_LB_display(  )
    call InitTrig_LB_hide(  )
    call InitTrig_flash_FCN(  )
    call InitTrig_share_vision(  )
    call InitTrig_timer(  )
    call InitTrig_VictoryDefeat(  )
    call InitTrig_init_hero_minibase(  )
    call InitTrig_miniBase(  )
    call InitTrig_record_hero_train(  )
    call InitTrig_record_hero_sell(  )
    call InitTrig_DefeatPlayer_FUNC(  )
    call InitTrig_LostUnit(  )
    call InitTrig_BuildUnit(  )
    call InitTrig_gg_command(  )
    call InitTrig_PlayerLeft(  )
    call InitTrig_fog_FCN(  )
    call InitTrig_init_fog(  )
    call InitTrig_poison_FCN(  )
    call InitTrig_fog_dispersed(  )
    call InitTrig_fog_start(  )
    call InitTrig_fog_coming(  )
    call InitTrig_fog(  )
    call InitTrig_init_creep(  )
    call InitTrig_check_regen(  )
    call InitTrig_hint_die(  )
    call InitTrig_creep_die(  )
endfunction

//===========================================================================
function RunInitializationTriggers takes nothing returns nothing
    call ConditionalTriggerExecute( gg_trg_init_variable )
    call ConditionalTriggerExecute( gg_trg_init_player )
    call ConditionalTriggerExecute( gg_trg_init_game )
    call ConditionalTriggerExecute( gg_trg_init_hero_minibase )
    call ConditionalTriggerExecute( gg_trg_init_fog )
    call ConditionalTriggerExecute( gg_trg_init_creep )
endfunction

//***************************************************************************
//*
//*  Players
//*
//***************************************************************************

function InitCustomPlayerSlots takes nothing returns nothing

    // Player 0
    call SetPlayerStartLocation( Player(0), 0 )
    call SetPlayerColor( Player(0), ConvertPlayerColor(0) )
    call SetPlayerRacePreference( Player(0), RACE_PREF_RANDOM )
    call SetPlayerRaceSelectable( Player(0), true )
    call SetPlayerController( Player(0), MAP_CONTROL_USER )

    // Player 1
    call SetPlayerStartLocation( Player(1), 1 )
    call SetPlayerColor( Player(1), ConvertPlayerColor(1) )
    call SetPlayerRacePreference( Player(1), RACE_PREF_RANDOM )
    call SetPlayerRaceSelectable( Player(1), true )
    call SetPlayerController( Player(1), MAP_CONTROL_USER )

    // Player 2
    call SetPlayerStartLocation( Player(2), 2 )
    call SetPlayerColor( Player(2), ConvertPlayerColor(2) )
    call SetPlayerRacePreference( Player(2), RACE_PREF_RANDOM )
    call SetPlayerRaceSelectable( Player(2), true )
    call SetPlayerController( Player(2), MAP_CONTROL_USER )

    // Player 3
    call SetPlayerStartLocation( Player(3), 3 )
    call SetPlayerColor( Player(3), ConvertPlayerColor(3) )
    call SetPlayerRacePreference( Player(3), RACE_PREF_RANDOM )
    call SetPlayerRaceSelectable( Player(3), true )
    call SetPlayerController( Player(3), MAP_CONTROL_USER )

    // Player 4
    call SetPlayerStartLocation( Player(4), 4 )
    call SetPlayerColor( Player(4), ConvertPlayerColor(4) )
    call SetPlayerRacePreference( Player(4), RACE_PREF_RANDOM )
    call SetPlayerRaceSelectable( Player(4), true )
    call SetPlayerController( Player(4), MAP_CONTROL_USER )

    // Player 5
    call SetPlayerStartLocation( Player(5), 5 )
    call SetPlayerColor( Player(5), ConvertPlayerColor(5) )
    call SetPlayerRacePreference( Player(5), RACE_PREF_RANDOM )
    call SetPlayerRaceSelectable( Player(5), true )
    call SetPlayerController( Player(5), MAP_CONTROL_USER )

    // Player 6
    call SetPlayerStartLocation( Player(6), 6 )
    call SetPlayerColor( Player(6), ConvertPlayerColor(6) )
    call SetPlayerRacePreference( Player(6), RACE_PREF_RANDOM )
    call SetPlayerRaceSelectable( Player(6), true )
    call SetPlayerController( Player(6), MAP_CONTROL_USER )

    // Player 7
    call SetPlayerStartLocation( Player(7), 7 )
    call SetPlayerColor( Player(7), ConvertPlayerColor(7) )
    call SetPlayerRacePreference( Player(7), RACE_PREF_RANDOM )
    call SetPlayerRaceSelectable( Player(7), true )
    call SetPlayerController( Player(7), MAP_CONTROL_USER )

    // Player 8
    call SetPlayerStartLocation( Player(8), 8 )
    call SetPlayerColor( Player(8), ConvertPlayerColor(8) )
    call SetPlayerRacePreference( Player(8), RACE_PREF_RANDOM )
    call SetPlayerRaceSelectable( Player(8), true )
    call SetPlayerController( Player(8), MAP_CONTROL_USER )

    // Player 9
    call SetPlayerStartLocation( Player(9), 9 )
    call SetPlayerColor( Player(9), ConvertPlayerColor(9) )
    call SetPlayerRacePreference( Player(9), RACE_PREF_RANDOM )
    call SetPlayerRaceSelectable( Player(9), true )
    call SetPlayerController( Player(9), MAP_CONTROL_USER )

    // Player 10
    call SetPlayerStartLocation( Player(10), 10 )
    call SetPlayerColor( Player(10), ConvertPlayerColor(10) )
    call SetPlayerRacePreference( Player(10), RACE_PREF_RANDOM )
    call SetPlayerRaceSelectable( Player(10), true )
    call SetPlayerController( Player(10), MAP_CONTROL_USER )

    // Player 11
    call SetPlayerStartLocation( Player(11), 11 )
    call SetPlayerColor( Player(11), ConvertPlayerColor(11) )
    call SetPlayerRacePreference( Player(11), RACE_PREF_RANDOM )
    call SetPlayerRaceSelectable( Player(11), true )
    call SetPlayerController( Player(11), MAP_CONTROL_USER )

endfunction

function InitCustomTeams takes nothing returns nothing
    // Force: FFA 组织者
    call SetPlayerTeam( Player(0), 0 )

    // Force: FFA 参与者
    call SetPlayerTeam( Player(1), 1 )
    call SetPlayerTeam( Player(2), 1 )
    call SetPlayerTeam( Player(3), 1 )
    call SetPlayerTeam( Player(4), 1 )
    call SetPlayerTeam( Player(5), 1 )
    call SetPlayerTeam( Player(6), 1 )
    call SetPlayerTeam( Player(7), 1 )
    call SetPlayerTeam( Player(8), 1 )
    call SetPlayerTeam( Player(9), 1 )
    call SetPlayerTeam( Player(10), 1 )
    call SetPlayerTeam( Player(11), 1 )

endfunction

function InitAllyPriorities takes nothing returns nothing

    call SetStartLocPrioCount( 0, 2 )
    call SetStartLocPrio( 0, 0, 6, MAP_LOC_PRIO_HIGH )
    call SetStartLocPrio( 0, 1, 9, MAP_LOC_PRIO_HIGH )

    call SetStartLocPrioCount( 1, 2 )
    call SetStartLocPrio( 1, 0, 7, MAP_LOC_PRIO_HIGH )
    call SetStartLocPrio( 1, 1, 11, MAP_LOC_PRIO_HIGH )

    call SetStartLocPrioCount( 2, 2 )
    call SetStartLocPrio( 2, 0, 8, MAP_LOC_PRIO_HIGH )
    call SetStartLocPrio( 2, 1, 9, MAP_LOC_PRIO_HIGH )

    call SetStartLocPrioCount( 3, 2 )
    call SetStartLocPrio( 3, 0, 7, MAP_LOC_PRIO_HIGH )
    call SetStartLocPrio( 3, 1, 10, MAP_LOC_PRIO_HIGH )

    call SetStartLocPrioCount( 4, 2 )
    call SetStartLocPrio( 4, 0, 8, MAP_LOC_PRIO_HIGH )
    call SetStartLocPrio( 4, 1, 11, MAP_LOC_PRIO_HIGH )

    call SetStartLocPrioCount( 5, 2 )
    call SetStartLocPrio( 5, 0, 6, MAP_LOC_PRIO_HIGH )
    call SetStartLocPrio( 5, 1, 10, MAP_LOC_PRIO_HIGH )

    call SetStartLocPrioCount( 6, 2 )
    call SetStartLocPrio( 6, 0, 0, MAP_LOC_PRIO_HIGH )
    call SetStartLocPrio( 6, 1, 5, MAP_LOC_PRIO_HIGH )

    call SetStartLocPrioCount( 7, 2 )
    call SetStartLocPrio( 7, 0, 1, MAP_LOC_PRIO_HIGH )
    call SetStartLocPrio( 7, 1, 3, MAP_LOC_PRIO_HIGH )

    call SetStartLocPrioCount( 8, 2 )
    call SetStartLocPrio( 8, 0, 2, MAP_LOC_PRIO_HIGH )
    call SetStartLocPrio( 8, 1, 4, MAP_LOC_PRIO_HIGH )

    call SetStartLocPrioCount( 9, 2 )
    call SetStartLocPrio( 9, 0, 0, MAP_LOC_PRIO_HIGH )
    call SetStartLocPrio( 9, 1, 2, MAP_LOC_PRIO_HIGH )

    call SetStartLocPrioCount( 10, 2 )
    call SetStartLocPrio( 10, 0, 3, MAP_LOC_PRIO_HIGH )
    call SetStartLocPrio( 10, 1, 5, MAP_LOC_PRIO_HIGH )

    call SetStartLocPrioCount( 11, 2 )
    call SetStartLocPrio( 11, 0, 1, MAP_LOC_PRIO_HIGH )
    call SetStartLocPrio( 11, 1, 4, MAP_LOC_PRIO_HIGH )
endfunction

//***************************************************************************
//*
//*  Main Initialization
//*
//***************************************************************************

//===========================================================================
function main takes nothing returns nothing
    call SetCameraBounds( -9472.0 + GetCameraMargin(CAMERA_MARGIN_LEFT), -9728.0 + GetCameraMargin(CAMERA_MARGIN_BOTTOM), 9472.0 - GetCameraMargin(CAMERA_MARGIN_RIGHT), 9216.0 - GetCameraMargin(CAMERA_MARGIN_TOP), -9472.0 + GetCameraMargin(CAMERA_MARGIN_LEFT), 9216.0 - GetCameraMargin(CAMERA_MARGIN_TOP), 9472.0 - GetCameraMargin(CAMERA_MARGIN_RIGHT), -9728.0 + GetCameraMargin(CAMERA_MARGIN_BOTTOM) )
    call SetDayNightModels( "Environment\\DNC\\DNCLordaeron\\DNCLordaeronTerrain\\DNCLordaeronTerrain.mdl", "Environment\\DNC\\DNCLordaeron\\DNCLordaeronUnit\\DNCLordaeronUnit.mdl" )
    call NewSoundEnvironment( "Default" )
    call SetAmbientDaySound( "LordaeronSummerDay" )
    call SetAmbientNightSound( "LordaeronSummerNight" )
    call SetMapMusic( "Music", true, 0 )
    call CreateAllUnits(  )
    call InitBlizzard(  )
    call InitGlobals(  )
    call InitCustomTriggers(  )
    call RunInitializationTriggers(  )

endfunction

//***************************************************************************
//*
//*  Map Configuration
//*
//***************************************************************************

function config takes nothing returns nothing
    call SetMapName( "TRIGSTR_001" )
    call SetMapDescription( "TRIGSTR_003" )
    call SetPlayers( 12 )
    call SetTeams( 12 )
    call SetGamePlacement( MAP_PLACEMENT_TEAMS_TOGETHER )

    call DefineStartLocation( 0, 8128.0, 1408.0 )
    call DefineStartLocation( 1, -8128.0, -1408.0 )
    call DefineStartLocation( 2, 5184.0, -6208.0 )
    call DefineStartLocation( 3, -5312.0, 6400.0 )
    call DefineStartLocation( 4, -2880.0, -7744.0 )
    call DefineStartLocation( 5, 2880.0, 7744.0 )
    call DefineStartLocation( 6, 6400.0, 5312.0 )
    call DefineStartLocation( 7, -7744.0, 2880.0 )
    call DefineStartLocation( 8, 1408.0, -8128.0 )
    call DefineStartLocation( 9, 7744.0, -2880.0 )
    call DefineStartLocation( 10, -1408.0, 8128.0 )
    call DefineStartLocation( 11, -6400.0, -5312.0 )

    // Player setup
    call InitCustomPlayerSlots(  )
    call InitCustomTeams(  )
    call InitAllyPriorities(  )
endfunction

